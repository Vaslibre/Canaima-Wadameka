!function(){var e,t,n,i,a,r,s,o,l,c,d,h,u,p,f,m,g,b,v,y,_,E,k,w,D,T,A,N,x,M,I,C,S,P,B,R,O,F,H,L,q,j,U,z,W,V,G,J,$,X,K,Y,Q,Z,et,tt,nt,it,at,rt,st={}.hasOwnProperty,ot=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},lt=function(e,t){function n(){this.constructor=e}for(var i in t)st.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},ct=[].slice;if(A=function(){function e(){}return e}(),A.Util=function(){function e(){}return e}(),A.Http=function(){function e(){}return e}(),A.File=function(){function e(){}return e}(),l="1.0.1","undefined"!=typeof global&&"undefined"!=typeof module&&"exports"in module)f=global,m=module.require.bind(module),module.exports=A;else if("undefined"!=typeof window&&"undefined"!=typeof navigator)f=window,m=null,window.Dropbox&&function(){var e,t,n,i;n=window.Dropbox,i=[];for(e in n)st.call(n,e)&&(t=n[e],i.push(A[e]=t));return i}(),window.Dropbox=A;else{if("undefined"==typeof self||"undefined"==typeof navigator)throw new Error("dropbox.js loaded in an unsupported JavaScript environment.");f=self,m=self.importScripts.bind(self),self.Dropbox=A}if(A.Env=function(){function e(){}return e.global=f,e.require=m,e}(),A.Util.EventSource=function(){function e(e){this._cancelable=e&&e.cancelable,this._listeners=[]}return e.prototype.addListener=function(e){if("function"!=typeof e)throw new TypeError("Invalid listener type; expected function");return ot.call(this._listeners,e)<0&&this._listeners.push(e),this},e.prototype.removeListener=function(e){var t,n,i,a,r,s;if(this._listeners.indexOf)n=this._listeners.indexOf(e),-1!==n&&this._listeners.splice(n,1);else for(s=this._listeners,t=a=0,r=s.length;r>a;t=++a)if(i=s[t],i===e){this._listeners.splice(t,1);break}return this},e.prototype.dispatch=function(e){var t,n,i,a,r;for(r=this._listeners,i=0,a=r.length;a>i;i++)if(t=r[i],n=t(e),this._cancelable&&n===!1)return!1;return!0},e}(),A.AccountInfo=function(){function e(e){var t;this._json=e,this.name=e.display_name,this.email=e.email,this.countryCode=e.country||null,this.uid=e.uid.toString(),e.public_app_url?(this.publicAppUrl=e.public_app_url,t=this.publicAppUrl.length-1,t>=0&&"/"===this.publicAppUrl.substring(t)&&(this.publicAppUrl=this.publicAppUrl.substring(0,t))):this.publicAppUrl=null,this.referralUrl=e.referral_link,this.quota=e.quota_info.quota,this.privateBytes=e.quota_info.normal||0,this.sharedBytes=e.quota_info.shared||0,this.usedQuota=this.privateBytes+this.sharedBytes}return e.parse=function(e){return e&&"object"==typeof e?new A.AccountInfo(e):e},e.prototype.name=null,e.prototype.email=null,e.prototype.countryCode=null,e.prototype.uid=null,e.prototype.referralUrl=null,e.prototype.publicAppUrl=null,e.prototype.quota=null,e.prototype.usedQuota=null,e.prototype.privateBytes=null,e.prototype.sharedBytes=null,e.prototype.json=function(){return this._json},e}(),A.ApiError=function(){function e(e,t,n){var i,a;if(this.method=t,this.url=n,this.status=e.status,e.responseType)try{i=e.response||e.responseText}catch(r){a=r;try{i=e.responseText}catch(r){a=r,i=null}}else try{i=e.responseText}catch(r){a=r,i=null}if(i)try{this.responseText=i.toString(),this.response=JSON.parse(i)}catch(r){a=r,this.response=null}else this.responseText="(no response)",this.response=null}return e.prototype.status=null,e.prototype.method=null,e.prototype.url=null,e.prototype.responseText=null,e.prototype.response=null,e.NETWORK_ERROR=0,e.NO_CONTENT=304,e.INVALID_PARAM=400,e.INVALID_TOKEN=401,e.OAUTH_ERROR=403,e.NOT_FOUND=404,e.INVALID_METHOD=405,e.NOT_ACCEPTABLE=406,e.CONFLICT=409,e.RATE_LIMITED=429,e.SERVER_ERROR=503,e.OVER_QUOTA=507,e.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText},e.prototype.inspect=function(){return this.toString()},e}(),A.AuthDriver=function(){function e(){}return e.prototype.authType=function(){return"code"},e.prototype.url=function(){return"https://some.url"},e.prototype.doAuthorize=function(e,t,n,i){return i({code:"access-code"})},e.prototype.getStateParam=function(e,t){return t(A.Util.Oauth.randomAuthStateParam())},e.prototype.resumeAuthorize=function(e,t,n){return n({code:"access-code"})},e.prototype.onAuthStateChange=function(e,t){return t()},e.oauthQueryParams=["access_token","expires_in","scope","token_type","code","error","error_description","error_uri","mac_key","mac_algorithm"].sort(),e}(),A.AuthDriver.autoConfigure=function(e){if("undefined"!=typeof chrome&&(chrome.extension||chrome.app&&chrome.app.runtime))return e.authDriver(new A.AuthDriver.Chrome),void 0;if("undefined"!=typeof window){if(window.cordova)return e.authDriver(new A.AuthDriver.Cordova),void 0;window&&window.navigator&&e.authDriver(new A.AuthDriver.Redirect)}},A.AuthDriver.BrowserBase=function(){function e(e){e?(this.rememberUser="rememberUser"in e?e.rememberUser:!0,this.scope=e.scope||"default"):(this.rememberUser=!0,this.scope="default"),this.storageKey=null,this.stateRe=/^[^#]+\#(.*&)?state=([^&]+)(&|$)/}return e.prototype.authType=function(){return"token"},e.prototype.onAuthStepChange=function(e,t){var n=this;switch(this.setStorageKey(e),e.authStep){case A.Client.RESET:return this.loadCredentials(function(i){return i?(e.setCredentials(i),e.authStep!==A.Client.DONE?t():n.rememberUser?(e.setCredentials(i),e.getAccountInfo(function(i){return i&&i.status===A.ApiError.INVALID_TOKEN?(e.reset(),n.forgetCredentials(t)):t()})):n.forgetCredentials(t)):t()});case A.Client.DONE:return this.rememberUser?this.storeCredentials(e.credentials(),t):this.forgetCredentials(t);case A.Client.SIGNED_OUT:return this.forgetCredentials(t);case A.Client.ERROR:return this.forgetCredentials(t);default:return t(),this}},e.prototype.setStorageKey=function(e){return this.storageKey="dropbox-auth:"+this.scope+":"+e.appHash(),this},e.prototype.storeCredentials=function(e,t){return localStorage.setItem(this.storageKey,JSON.stringify(e)),t(),this},e.prototype.loadCredentials=function(e){var t,n;if(n=localStorage.getItem(this.storageKey),!n)return e(null),this;try{e(JSON.parse(n))}catch(i){t=i,e(null)}return this},e.prototype.forgetCredentials=function(e){return localStorage.removeItem(this.storageKey),e(),this},e.prototype.locationStateParam=function(e){var t,n;return t=e||A.AuthDriver.BrowserBase.currentLocation(),n=this.stateRe.exec(t),n?decodeURIComponent(n[2]):null},e.prototype.replaceUrlBasename=function(e,t){var n,i,a;return i=e.indexOf("#"),-1!==i&&(e=e.substring(0,i)),a=e.indexOf("?"),-1!==a&&(e=e.substring(0,a)),n=e.split("/"),n[n.length-1]=t,n.join("/")},e.currentLocation=function(){return window.location.href},e.cleanupLocation=function(){var e,t;window.history&&window.history.replaceState?(t=this.currentLocation(),e=t.indexOf("#"),window.history.replaceState({},document.title,t.substring(0,e))):window.location.hash=""},e}(),A.AuthDriver.Redirect=function(e){function t(e){t.__super__.constructor.call(this,e),this.receiverUrl=this.baseUrl(e)}return lt(t,e),t.prototype.baseUrl=function(e){var t,n;if(n=A.AuthDriver.BrowserBase.currentLocation(),e){if(e.redirectUrl)return e.redirectUrl;if(e.redirectFile)return this.replaceUrlBasename(n,e.redirectFile)}return t=n.indexOf("#"),-1!==t&&(n=n.substring(0,t)),n},t.prototype.url=function(){return this.receiverUrl},t.prototype.doAuthorize=function(e,t,n){return this.storeCredentials(n.credentials(),function(){return window.location.assign(e)})},t.prototype.resumeAuthorize=function(e,t,n){var i;return this.locationStateParam()===e?(i=A.AuthDriver.BrowserBase.currentLocation(),A.AuthDriver.BrowserBase.cleanupLocation(),n(A.Util.Oauth.queryParamsFromUrl(i))):this.forgetCredentials(function(){return n({error:"Authorization error"})})},t}(A.AuthDriver.BrowserBase),A.AuthDriver.Popup=function(e){function t(e){t.__super__.constructor.call(this,e),this.receiverUrl=this.baseUrl(e)}return lt(t,e),t.prototype.url=function(){return this.receiverUrl},t.prototype.doAuthorize=function(e,t,n,i){return this.listenForMessage(t,i),this.openWindow(e)},t.prototype.baseUrl=function(e){var t;if(t=A.AuthDriver.BrowserBase.currentLocation(),e){if(e.receiverUrl)return e.receiverUrl;if(e.receiverFile)return this.replaceUrlBasename(t,e.receiverFile)}return t},t.prototype.openWindow=function(e){return window.open(e,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,700))},t.prototype.popupWindowSpec=function(e,t){var n,i,a,r,s,o,l,c,d,h;return s=null!=(l=window.screenX)?l:window.screenLeft,o=null!=(c=window.screenY)?c:window.screenTop,r=null!=(d=window.outerWidth)?d:document.documentElement.clientWidth,n=null!=(h=window.outerHeight)?h:document.documentElement.clientHeight,i=Math.round(s+(r-e)/2),a=Math.round(o+(n-t)/2.5),s>i&&(i=s),o>a&&(a=o),"width="+e+",height="+t+","+("left="+i+",top="+a)+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"},t.prototype.listenForMessage=function(e,t){var n,i=this;return n=function(a){var r,s,o;r=a.data?a.data:a;try{o=JSON.parse(r)._dropboxjs_oauth_info}catch(l){return s=l,void 0}return o?i.locationStateParam(o)===e?(e=!1,window.removeEventListener("message",n),A.AuthDriver.Popup.onMessage.removeListener(n),t(A.Util.Oauth.queryParamsFromUrl(r))):void 0:void 0},window.addEventListener("message",n,!1),A.AuthDriver.Popup.onMessage.addListener(n)},t.locationOrigin=function(e){var t;return(t=/^(file:\/\/[^\?\#]*)(\?|\#|$)/.exec(e))?t[1]:(t=/^([^\:]+\:\/\/[^\/\?\#]*)(\/|\?|\#|$)/.exec(e),t?t[1]:e)},t.oauthReceiver=function(){window.addEventListener("load",function(){var e,t,n,i,a,r;if(r=window.location.href,n=JSON.stringify({_dropboxjs_oauth_info:r}),A.AuthDriver.BrowserBase.cleanupLocation(),i=window.opener,window.parent!==window.top&&(i||(i=window.parent)),i){try{a=window.location.origin||locationOrigin(r),i.postMessage(n,a),window.close()}catch(s){t=s}try{return i.Dropbox.AuthDriver.Popup.onMessage.dispatch(n),window.close()}catch(s){e=s}}})},t.onMessage=new A.Util.EventSource,t}(A.AuthDriver.BrowserBase),h=null,u=null,"undefined"!=typeof chrome&&null!==chrome&&(chrome.runtime&&(chrome.runtime.onMessage&&(h=chrome.runtime.onMessage),chrome.runtime.sendMessage&&(u=chrome.runtime.sendMessage.bind(chrome.runtime))),chrome.extension&&(chrome.extension.onMessage&&(h||(h=chrome.extension.onMessage)),chrome.extension.sendMessage&&(u||(u=chrome.extension.sendMessage.bind(chrome.extension))))),A.AuthDriver.Chrome=function(e){function t(e){var n;t.__super__.constructor.call(this,e),n=e&&e.receiverPath||"chrome_oauth_receiver.html",this.useQuery=!0,this.receiverUrl=this.expandUrl(n),this.storageKey="dropbox_js_"+this.scope+"_credentials"}return lt(t,e),t.prototype.onMessage=h,t.prototype.sendMessage=u,t.prototype.expandUrl=function(e){return chrome.runtime&&chrome.runtime.getURL?chrome.runtime.getURL(e):chrome.extension&&chrome.extension.getURL?chrome.extension.getURL(e):e},t.prototype.onAuthStepChange=function(e,t){var n=this;switch(e.authStep){case A.Client.RESET:return this.loadCredentials(function(i){if(i){if(i.authStep)return n.forgetCredentials(t);e.setCredentials(i)}return t()});case A.Client.DONE:return this.storeCredentials(e.credentials(),t);case A.Client.SIGNED_OUT:return this.forgetCredentials(t);case A.Client.ERROR:return this.forgetCredentials(t);default:return t()}},t.prototype.doAuthorize=function(e,t,n,i){var a,r,s,o,l=this;return(null!=(r=chrome.identity)?r.launchWebAuthFlow:void 0)?chrome.identity.launchWebAuthFlow({url:e,interactive:!0},function(e){return l.locationStateParam(e)===t?(t=!1,i(A.Util.Oauth.queryParamsFromUrl(e))):void 0}):(null!=(s=chrome.experimental)?null!=(o=s.identity)?o.launchWebAuthFlow:void 0:void 0)?chrome.experimental.identity.launchWebAuthFlow({url:e,interactive:!0},function(e){return l.locationStateParam(e)===t?(t=!1,i(A.Util.Oauth.queryParamsFromUrl(e))):void 0}):(a={handle:null},this.listenForMessage(t,a,i),this.openWindow(e,function(e){return a.handle=e}))},t.prototype.openWindow=function(e,t){return chrome.tabs&&chrome.tabs.create?(chrome.tabs.create({url:e,active:!0,pinned:!1},function(e){return t(e)}),this):this},t.prototype.closeWindow=function(e){return chrome.tabs&&chrome.tabs.remove&&e.id?(chrome.tabs.remove(e.id),this):chrome.app&&chrome.app.window&&e.close?(e.close(),this):this},t.prototype.url=function(){return this.receiverUrl},t.prototype.listenForMessage=function(e,t,n){var i,a=this;return i=function(r,s){var o;return s&&s.tab&&s.tab.url.substring(0,a.receiverUrl.length)!==a.receiverUrl||!r.dropbox_oauth_receiver_href?void 0:(o=r.dropbox_oauth_receiver_href,a.locationStateParam(o)===e?(e=!1,t.handle&&a.closeWindow(t.handle),a.onMessage.removeListener(i),n(A.Util.Oauth.queryParamsFromUrl(o))):void 0)},this.onMessage.addListener(i)},t.prototype.storeCredentials=function(e,t){var n;return n={},n[this.storageKey]=e,chrome.storage.local.set(n,t),this},t.prototype.loadCredentials=function(e){var t=this;return chrome.storage.local.get(this.storageKey,function(n){return e(n[t.storageKey]||null)}),this},t.prototype.forgetCredentials=function(e){return chrome.storage.local.remove(this.storageKey,e),this},t.oauthReceiver=function(){return window.addEventListener("load",function(){var e,t;return e=new A.AuthDriver.Chrome,t=window.location.href,window.location.hash="",e.sendMessage({dropbox_oauth_receiver_href:t}),window.close?window.close():void 0})},t}(A.AuthDriver.BrowserBase),A.AuthDriver.Cordova=function(e){function t(e){t.__super__.constructor.call(this,e)}return lt(t,e),t.prototype.url=function(){return"https://www.dropbox.com/1/oauth2/redirect_receiver"},t.prototype.doAuthorize=function(e,t,n,i){var a,r,s,o,l,c=this;return r=window.open(e,"_blank","location=yes,closebuttoncaption=Cancel"),o=!1,a=/^[^/]*\/\/[^/]*\//.exec(e)[0],l=!1,s=function(e){if(e.url&&c.locationStateParam(e.url)===t){if(l)return;return r.removeEventListener("loadstart",s),r.removeEventListener("loaderror",s),r.removeEventListener("loadstop",s),r.removeEventListener("exit",s),l=!0,window.setTimeout(function(){return r.close()},10),i(A.Util.Oauth.queryParamsFromUrl(e.url)),void 0}if("exit"===e.type){if(l)return;r.removeEventListener("loadstart",s),r.removeEventListener("loaderror",s),r.removeEventListener("loadstop",s),r.removeEventListener("exit",s),l=!0,i(new AuthError("error=access_denied&error_description=User+closed+browser+window"))}},r.addEventListener("loadstart",s),r.addEventListener("loaderror",s),r.addEventListener("loadstop",s),r.addEventListener("exit",s)},t}(A.AuthDriver.BrowserBase),A.AuthDriver.NodeServer=function(){function e(e){this._port=(null!=e?e.port:void 0)||8912,(null!=e?e.tls:void 0)?(this._tlsOptions=e.tls,("string"==typeof this._tlsOptions||this._tlsOptions instanceof Buffer)&&(this._tlsOptions={key:this._tlsOptions,cert:this._tlsOptions})):this._tlsOptions=null,this._fs=A.Env.require("fs"),this._http=A.Env.require("http"),this._https=A.Env.require("https"),this._open=A.Env.require("open"),this._callbacks={},this._nodeUrl=A.Env.require("url"),this.createApp()}return e.prototype.authType=function(){return"code"},e.prototype.url=function(){var e;return e=null===this._tlsOptions?"http":"https",""+e+"://localhost:"+this._port+"/oauth_callback"},e.prototype.doAuthorize=function(e,t,n,i){return this._callbacks[t]=i,this.openBrowser(e)},e.prototype.openBrowser=function(e){if(!e.match(/^https?:\/\//))throw new Error("Not a http/https URL: "+e);return"BROWSER"in process.env?this._open(e,process.env.BROWSER):this._open(e)},e.prototype.createApp=function(){var e=this;return this._app=this._tlsOptions?this._https.createServer(this._tlsOptions,function(t,n){return e.doRequest(t,n)}):this._http.createServer(function(t,n){return e.doRequest(t,n)}),this._app.listen(this._port)},e.prototype.closeServer=function(){return this._app.close()},e.prototype.doRequest=function(e,t){var n,i,a,r=this;return a=this._nodeUrl.parse(e.url,!0),"/oauth_callback"===a.pathname&&(i=a.query.state,this._callbacks[i]&&(this._callbacks[i](a.query),delete this._callbacks[i])),n="",e.on("data",function(e){return n+=e}),e.on("end",function(){return r.closeBrowser(t)})},e.prototype.closeBrowser=function(e){var t;return t='<!doctype html>\n<script type="text/javascript">window.close();</script>\n<p>Please close this window.</p>',e.writeHead(200,{"Content-Length":t.length,"Content-Type":"text/html"}),e.write(t),e.end()},e}(),A.AuthError=function(){function e(e){var t;if(!e.error)throw new Error("Not an OAuth 2.0 error: "+JSON.stringify(e));t="object"==typeof e.error&&e.error.error?e.error:e,this.code=t.error,this.description=t.error_description||null,this.uri=t.error_uri||null}return e.prototype.code=null,e.prototype.description=null,e.prototype.uri=null,e.ACCESS_DENIED="access_denied",e.INVALID_REQUEST="invalid_request",e.UNAUTHORIZED_CLIENT="unauthorized_client",e.INVALID_GRANT="invalid_grant",e.INVALID_SCOPE="invalid_scope",e.UNSUPPORTED_GRANT_TYPE="unsupported_grant_type",e.UNSUPPORTED_RESPONSE_TYPE="unsupported_response_type",e.SERVER_ERROR="server_error",e.TEMPORARILY_UNAVAILABLE="temporarily_unavailable",e.prototype.toString=function(){return"Dropbox OAuth error "+this.code+" :: "+this.description},e.prototype.inspect=function(){return this.toString()},e}(),A.Client=function(){function e(e){var t=this;this.serverRoot=e.server||this.defaultServerRoot(),this.maxApiServer="maxApiServer"in e?e.maxApiServer:this.defaultMaxApiServer(),this.authServer=e.authServer||this.defaultAuthServer(),this.fileServer=e.fileServer||this.defaultFileServer(),this.downloadServer=e.downloadServer||this.defaultDownloadServer(),this.onXhr=new A.Util.EventSource({cancelable:!0}),this.onError=new A.Util.EventSource,this.onAuthStepChange=new A.Util.EventSource,this.xhrOnErrorHandler=function(e,n){return t.handleXhrError(e,n)},this.oauth=new A.Util.Oauth(e),this.uid=e.uid||null,this.authStep=this.oauth.step(),this.driver=null,this.filter=null,this.authError=null,this._credentials=null,this._datastoreManager=null,this.setupUrls()}return e.prototype.onXhr=null,e.prototype.onError=null,e.prototype.onAuthStepChange=null,e.prototype.authDriver=function(e){return this.driver=e,this},e.prototype.dropboxUid=function(){return this.uid},e.prototype.credentials=function(){return this._credentials||this.computeCredentials(),this._credentials},e.prototype.authenticate=function(e,t){var n,i,a,r,s,o=this;if(t||"function"!=typeof e||(t=e,e=null),n=e&&"interactive"in e?e.interactive:!0,!this.driver&&this.authStep!==p.DONE&&(A.AuthDriver.autoConfigure(this),!this.driver))throw new Error("OAuth driver auto-configuration failed. Call authDriver.");if(this.authStep===p.ERROR)throw new Error("Client got in an error state. Call reset() to reuse it!");return r=function(){return o.authStep=o.oauth.step(),o.authStep===p.ERROR&&(o.authError=o.oauth.error()),o._credentials=null,o.onAuthStepChange.dispatch(o),s()},a=function(){return o.authStep=p.ERROR,o._credentials=null,o.onAuthStepChange.dispatch(o),s()},i=null,s=function(){var e;if(i!==o.authStep&&(i=o.authStep,o.driver&&o.driver.onAuthStepChange))return o.driver.onAuthStepChange(o,s),void 0;switch(o.authStep){case p.RESET:return n?(o.driver.getStateParam&&o.driver.getStateParam(function(e){return o.client.authStep===p.RESET&&o.oauth.setAuthStateParam(e),r()}),o.oauth.setAuthStateParam(A.Util.Oauth.randomAuthStateParam()),r()):(t&&t(null,o),void 0);case p.PARAM_SET:return n?(e=o.authorizeUrl(),o.driver.doAuthorize(e,o.oauth.authStateParam(),o,function(e){return o.oauth.processRedirectParams(e),e.uid&&(o.uid=e.uid),r()})):(t&&t(null,o),void 0);case p.PARAM_LOADED:return o.driver.resumeAuthorize?o.driver.resumeAuthorize(o.oauth.authStateParam(),o,function(e){return o.oauth.processRedirectParams(e),e.uid&&(o.uid=e.uid),r()}):(o.oauth.setAuthStateParam(o.oauth.authStateParam()),r(),void 0);case p.AUTHORIZED:return o.getAccessToken(function(e,t){return e?(o.authError=e,a()):(o.oauth.processRedirectParams(t),o.uid=t.uid,r())});case p.DONE:t&&t(null,o);break;case p.SIGNED_OUT:return o.authStep=p.RESET,o.reset(),s();case p.ERROR:t&&t(o.authError,o)}},s(),this},e.prototype.isAuthenticated=function(){return this.authStep===p.DONE},e.prototype.signOut=function(e,t){var n,i,a=this;if(t||"function"!=typeof e||(t=e,e=null),n=e&&e.mustInvalidate,this.authStep!==p.DONE)throw new Error("This client doesn't have a user's token");return i=new A.Util.Xhr("POST",this.urls.signOut),i.signWithOauth(this.oauth),this.dispatchXhr(i,function(e){if(e)if(e.status===A.ApiError.INVALID_TOKEN)e=null;else if(n)return t&&t(e),void 0;return a.authStep=p.RESET,a.reset(),a.authStep=p.SIGNED_OUT,a.onAuthStepChange.dispatch(a),a.driver&&a.driver.onAuthStepChange?a.driver.onAuthStepChange(a,function(){return t?t(null):void 0}):t?t(null):void 0})},e.prototype.signOff=function(e,t){return this.signOut(e,t)},e.prototype.getAccountInfo=function(e,t){var n,i;return t||"function"!=typeof e||(t=e,e=null),n=!1,e&&e.httpCache&&(n=!0),i=new A.Util.Xhr("GET",this.urls.accountInfo),i.signWithOauth(this.oauth,n),this.dispatchXhr(i,function(e,n){return t(e,A.AccountInfo.parse(n),n)})},e.prototype.getUserInfo=function(e,t){return this.getAccountInfo(e,t)},e.prototype.readFile=function(e,t,n){var i,a,r,s,o,l,c;return n||"function"!=typeof t||(n=t,t=null),a={},l="text",s=null,i=!1,t&&(t.versionTag?a.rev=t.versionTag:t.rev&&(a.rev=t.rev),t.arrayBuffer?l="arraybuffer":t.blob?l="blob":t.buffer?l="buffer":t.binary&&(l="b"),t.length?(null!=t.start?(o=t.start,r=t.start+t.length-1):(o="",r=t.length),s="bytes="+o+"-"+r):null!=t.start&&(s="bytes="+t.start+"-"),t.httpCache&&(i=!0)),c=new A.Util.Xhr("GET",""+this.urls.getFile+"/"+this.urlEncodePath(e)),c.setParams(a).signWithOauth(this.oauth,i),c.setResponseType(l),s&&(s&&c.setHeader("Range",s),c.reportResponseHeaders()),this.dispatchXhr(c,function(e,t,i,a){var r;return r=a?A.Http.RangeInfo.parse(a["content-range"]):null,n(e,t,A.File.Stat.parse(i),r)})},e.prototype.writeFile=function(e,t,n,i){var a;return i||"function"!=typeof n||(i=n,n=null),a=A.Util.Xhr.canSendForms&&"object"==typeof t,a?this.writeFileUsingForm(e,t,n,i):this.writeFileUsingPut(e,t,n,i)},e.prototype.writeFileUsingForm=function(e,t,n,i){var a,r,s,o;return s=e.lastIndexOf("/"),-1===s?(a=e,e=""):(a=e.substring(s),e=e.substring(0,s)),r={file:a},n&&(n.noOverwrite&&(r.overwrite="false"),n.lastVersionTag?r.parent_rev=n.lastVersionTag:(n.parentRev||n.parent_rev)&&(r.parent_rev=n.parentRev||n.parent_rev)),o=new A.Util.Xhr("POST",""+this.urls.postFile+"/"+this.urlEncodePath(e)),o.setParams(r).signWithOauth(this.oauth).setFileField("file",a,t,"application/octet-stream"),delete r.file,this.dispatchXhr(o,function(e,t){return i?i(e,A.File.Stat.parse(t)):void 0})},e.prototype.writeFileUsingPut=function(e,t,n,i){var a,r;return a={},n&&(n.noOverwrite&&(a.overwrite="false"),n.lastVersionTag?a.parent_rev=n.lastVersionTag:(n.parentRev||n.parent_rev)&&(a.parent_rev=n.parentRev||n.parent_rev)),r=new A.Util.Xhr("POST",""+this.urls.putFile+"/"+this.urlEncodePath(e)),r.setBody(t).setParams(a).signWithOauth(this.oauth),this.dispatchXhr(r,function(e,t){return i?i(e,A.File.Stat.parse(t)):void 0})},e.prototype.resumableUploadStep=function(e,t,n){var i,a;return t?(i={offset:t.offset},t.tag&&(i.upload_id=t.tag)):i={offset:0},a=new A.Util.Xhr("POST",this.urls.chunkedUpload),a.setBody(e).setParams(i).signWithOauth(this.oauth),this.dispatchXhr(a,function(e,t){return e&&e.status===A.ApiError.INVALID_PARAM&&e.response&&e.response.upload_id&&e.response.offset?n(null,A.Http.UploadCursor.parse(e.response)):n(e,A.Http.UploadCursor.parse(t))})},e.prototype.resumableUploadFinish=function(e,t,n,i){var a,r;return i||"function"!=typeof n||(i=n,n=null),a={upload_id:t.tag},n&&(n.lastVersionTag?a.parent_rev=n.lastVersionTag:(n.parentRev||n.parent_rev)&&(a.parent_rev=n.parentRev||n.parent_rev),n.noOverwrite&&(a.overwrite="false")),r=new A.Util.Xhr("POST",""+this.urls.commitChunkedUpload+"/"+this.urlEncodePath(e)),r.setParams(a).signWithOauth(this.oauth),this.dispatchXhr(r,function(e,t){return i?i(e,A.File.Stat.parse(t)):void 0})},e.prototype.stat=function(e,t,n){var i,a,r;return n||"function"!=typeof t||(n=t,t=null),a={},i=!1,t&&(t.versionTag?a.rev=t.versionTag:t.rev&&(a.rev=t.rev),t.contentHash?a.hash=t.contentHash:t.hash&&(a.hash=t.hash),(t.removed||t.deleted)&&(a.include_deleted="true"),t.readDir&&(a.list="true",t.readDir!==!0&&(a.file_limit=t.readDir.toString())),t.cacheHash&&(a.hash=t.cacheHash),t.httpCache&&(i=!0)),a.include_deleted||(a.include_deleted="false"),a.list||(a.list="false"),r=new A.Util.Xhr("GET",""+this.urls.metadata+"/"+this.urlEncodePath(e)),r.setParams(a).signWithOauth(this.oauth,i),this.dispatchXhr(r,function(e,t){var i,a,r;return r=A.File.Stat.parse(t),i=(null!=t?t.contents:void 0)?function(){var e,n,i,r;for(i=t.contents,r=[],e=0,n=i.length;n>e;e++)a=i[e],r.push(A.File.Stat.parse(a));return r}():void 0,n(e,r,i)})},e.prototype.readdir=function(e,t,n){var i;return n||"function"!=typeof t||(n=t,t=null),i={readDir:!0},t&&(null!=t.limit&&(i.readDir=t.limit),t.versionTag?i.versionTag=t.versionTag:t.rev&&(i.versionTag=t.rev),t.contentHash?i.contentHash=t.contentHash:t.hash&&(i.contentHash=t.hash),(t.removed||t.deleted)&&(i.removed=t.removed||t.deleted),t.httpCache&&(i.httpCache=t.httpCache)),this.stat(e,i,function(e,t,i){var a,r;return a=i?function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)r=i[e],n.push(r.name);return n}():null,n(e,a,t,i)})},e.prototype.metadata=function(e,t,n){return this.stat(e,t,n)},e.prototype.makeUrl=function(e,t,n){var i,a,r,s,o,l=this;return n||"function"!=typeof t||(n=t,t=null),a=t&&(t["long"]||t.longUrl||t.downloadHack)?{short_url:"false"}:{},e=this.urlEncodePath(e),r=""+this.urls.shares+"/"+e,i=!1,s=!1,t&&(t.downloadHack?(i=!0,s=!0):t.download&&(i=!0,r=""+this.urls.media+"/"+e)),o=new A.Util.Xhr("POST",r).setParams(a).signWithOauth(this.oauth),this.dispatchXhr(o,function(e,t){return s&&(null!=t?t.url:void 0)&&(t.url=t.url.replace(l.authServer,l.downloadServer)),n(e,A.File.ShareUrl.parse(t,i))})},e.prototype.history=function(e,t,n){var i,a,r;return n||"function"!=typeof t||(n=t,t=null),a={},i=!1,t&&(null!=t.limit&&(a.rev_limit=t.limit),t.httpCache&&(i=!0)),r=new A.Util.Xhr("GET",""+this.urls.revisions+"/"+this.urlEncodePath(e)),r.setParams(a).signWithOauth(this.oauth,i),this.dispatchXhr(r,function(e,t){var i,a;return a=t?function(){var e,n,a;for(a=[],e=0,n=t.length;n>e;e++)i=t[e],a.push(A.File.Stat.parse(i));return a}():void 0,n(e,a)})},e.prototype.revisions=function(e,t,n){return this.history(e,t,n)},e.prototype.thumbnailUrl=function(e,t){var n;return n=this.thumbnailXhr(e,t),n.paramsToUrl().url},e.prototype.readThumbnail=function(e,t,n){var i,a;return n||"function"!=typeof t||(n=t,t=null),i="b",t&&(t.blob&&(i="blob"),t.arrayBuffer&&(i="arraybuffer"),t.buffer&&(i="buffer")),a=this.thumbnailXhr(e,t),a.setResponseType(i),this.dispatchXhr(a,function(e,t,i){return n(e,t,A.File.Stat.parse(i))})},e.prototype.thumbnailXhr=function(e,t){var n,i;return n={},t&&(t.format?n.format=t.format:t.png&&(n.format="png"),t.size&&(n.size=t.size)),i=new A.Util.Xhr("GET",""+this.urls.thumbnails+"/"+this.urlEncodePath(e)),i.setParams(n).signWithOauth(this.oauth)},e.prototype.revertFile=function(e,t,n){var i;return i=new A.Util.Xhr("POST",""+this.urls.restore+"/"+this.urlEncodePath(e)),i.setParams({rev:t}).signWithOauth(this.oauth),this.dispatchXhr(i,function(e,t){return n?n(e,A.File.Stat.parse(t)):void 0})},e.prototype.restore=function(e,t,n){return this.revertFile(e,t,n)},e.prototype.findByName=function(e,t,n,i){var a,r,s;return i||"function"!=typeof n||(i=n,n=null),r={query:t},a=!1,n&&(null!=n.limit&&(r.file_limit=n.limit),(n.removed||n.deleted)&&(r.include_deleted=!0),n.httpCache&&(a=!0)),s=new A.Util.Xhr("GET",""+this.urls.search+"/"+this.urlEncodePath(e)),s.setParams(r).signWithOauth(this.oauth,a),this.dispatchXhr(s,function(e,t){var n,a;return a=t?function(){var e,i,a;for(a=[],e=0,i=t.length;i>e;e++)n=t[e],a.push(A.File.Stat.parse(n));return a}():void 0,i(e,a)})},e.prototype.search=function(e,t,n,i){return this.findByName(e,t,n,i)},e.prototype.makeCopyReference=function(e,t){var n;return n=new A.Util.Xhr("GET",""+this.urls.copyRef+"/"+this.urlEncodePath(e)),n.signWithOauth(this.oauth),this.dispatchXhr(n,function(e,n){return t(e,A.File.CopyReference.parse(n))})},e.prototype.copyRef=function(e,t){return this.makeCopyReference(e,t)},e.prototype.pullChanges=function(e,t){var n,i;return t||"function"!=typeof e||(t=e,e=null),n=e?e.cursorTag?{cursor:e.cursorTag}:{cursor:e}:{},i=new A.Util.Xhr("POST",this.urls.delta),i.setParams(n).signWithOauth(this.oauth),this.dispatchXhr(i,function(e,n){return t(e,A.Http.PulledChanges.parse(n))})},e.prototype.delta=function(e,t){return this.pullChanges(e,t)},e.prototype.mkdir=function(e,t){var n;return n=new A.Util.Xhr("POST",this.urls.fileopsCreateFolder),n.setParams({root:"auto",path:this.normalizePath(e)}).signWithOauth(this.oauth),this.dispatchXhr(n,function(e,n){return t?t(e,A.File.Stat.parse(n)):void 0})},e.prototype.remove=function(e,t){var n;return n=new A.Util.Xhr("POST",this.urls.fileopsDelete),n.setParams({root:"auto",path:this.normalizePath(e)}).signWithOauth(this.oauth),this.dispatchXhr(n,function(e,n){return t?t(e,A.File.Stat.parse(n)):void 0})},e.prototype.unlink=function(e,t){return this.remove(e,t)},e.prototype["delete"]=function(e,t){return this.remove(e,t)},e.prototype.copy=function(e,t,n){var i,a,r;return n||"function"!=typeof i||(n=i,i=null),a={root:"auto",to_path:this.normalizePath(t)},e instanceof A.File.CopyReference?a.from_copy_ref=e.tag:a.from_path=this.normalizePath(e),r=new A.Util.Xhr("POST",this.urls.fileopsCopy),r.setParams(a).signWithOauth(this.oauth),this.dispatchXhr(r,function(e,t){return n?n(e,A.File.Stat.parse(t)):void 0})},e.prototype.move=function(e,t,n){var i,a;return n||"function"!=typeof i||(n=i,i=null),a=new A.Util.Xhr("POST",this.urls.fileopsMove),a.setParams({root:"auto",from_path:this.normalizePath(e),to_path:this.normalizePath(t)}).signWithOauth(this.oauth),this.dispatchXhr(a,function(e,t){return n?n(e,A.File.Stat.parse(t)):void 0})},e.prototype.appInfo=function(e,t){var n;return t||"function"!=typeof e||(t=e,e=this.oauth.credentials().key),n=new A.Util.Xhr("GET",this.urls.appsInfo),n.setParams({app_key:e}),this.dispatchXhr(n,function(n,i){return t(n,A.Http.AppInfo.parse(i,e))})},e.prototype.isAppDeveloper=function(e,t,n){var i;return"object"==typeof e&&"uid"in e&&(e=e.uid),n||"function"!=typeof t?"object"==typeof t&&"key"in t&&(t=t.key):(n=t,t=this.oauth.credentials().key),i=new A.Util.Xhr("GET",this.urls.appsCheckDeveloper),i.setParams({app_key:t,uid:e}),this.dispatchXhr(i,function(e,t){return t?n(e,t.is_developer):n(e)})},e.prototype.hasOauthRedirectUri=function(e,t,n){var i;return n||"function"!=typeof t?"object"==typeof t&&"key"in t&&(t=t.key):(n=t,t=this.oauth.credentials().key),i=new A.Util.Xhr("GET",this.urls.appsCheckRedirectUri),i.setParams({app_key:t,redirect_uri:e}),this.dispatchXhr(i,function(e,t){return t?n(e,t.has_redirect_uri):n(e)})},e.prototype.reset=function(){var e;return this.uid=null,this.oauth.reset(),e=this.authStep,this.authStep=this.oauth.step(),e!==this.authStep&&this.onAuthStepChange.dispatch(this),this.authError=null,this._credentials=null,this},e.prototype.setCredentials=function(e){var t;return t=this.authStep,this.oauth.setCredentials(e),this.authStep=this.oauth.step(),this.uid=e.uid||null,this.authError=null,this._credentials=null,t!==this.authStep&&this.onAuthStepChange.dispatch(this),this},e.prototype.appHash=function(){return this.oauth.appHash()},e.prototype.setupUrls=function(){return this.apiServer=this.chooseApiServer(),this.urls={authorize:""+this.authServer+"/1/oauth2/authorize",token:""+this.apiServer+"/1/oauth2/token",signOut:""+this.apiServer+"/1/unlink_access_token",accountInfo:""+this.apiServer+"/1/account/info",getFile:""+this.fileServer+"/1/files/auto",postFile:""+this.fileServer+"/1/files/auto",putFile:""+this.fileServer+"/1/files_put/auto",metadata:""+this.apiServer+"/1/metadata/auto",delta:""+this.apiServer+"/1/delta",revisions:""+this.apiServer+"/1/revisions/auto",restore:""+this.apiServer+"/1/restore/auto",search:""+this.apiServer+"/1/search/auto",shares:""+this.apiServer+"/1/shares/auto",media:""+this.apiServer+"/1/media/auto",copyRef:""+this.apiServer+"/1/copy_ref/auto",thumbnails:""+this.fileServer+"/1/thumbnails/auto",chunkedUpload:""+this.fileServer+"/1/chunked_upload",commitChunkedUpload:""+this.fileServer+"/1/commit_chunked_upload/auto",fileopsCopy:""+this.apiServer+"/1/fileops/copy",fileopsCreateFolder:""+this.apiServer+"/1/fileops/create_folder",fileopsDelete:""+this.apiServer+"/1/fileops/delete",fileopsMove:""+this.apiServer+"/1/fileops/move",appsInfo:""+this.apiServer+"/1/apps/info",appsCheckDeveloper:""+this.apiServer+"/1/apps/check_developer",appsCheckRedirectUri:""+this.apiServer+"/1/apps/check_redirect_uri",getDb:""+this.apiServer+"/r5/datastores/get_datastore",getOrCreateDb:""+this.apiServer+"/r5/datastores/get_or_create_datastore",createDb:""+this.apiServer+"/r5/datastores/create_datastore",listDbs:""+this.apiServer+"/r5/datastores/list_datastores",deleteDb:""+this.apiServer+"/r5/datastores/delete_datastore",getSnapshot:""+this.apiServer+"/r5/datastores/get_snapshot",getDeltas:""+this.apiServer+"/r5/datastores/get_deltas",putDelta:""+this.apiServer+"/r5/datastores/put_delta",datastoreAwait:""+this.apiServer+"/r5/datastores/await"},this
},e.prototype.chooseApiServer=function(){var e,t;return t=Math.floor(Math.random()*(this.maxApiServer+1)),e=0===t?"":t.toString(),this.serverRoot.replace("$",e)},e.prototype.authStep=null,e.ERROR=0,e.RESET=1,e.PARAM_SET=2,e.PARAM_LOADED=3,e.AUTHORIZED=4,e.DONE=5,e.SIGNED_OUT=6,e.prototype.urlEncodePath=function(e){return A.Util.Xhr.urlEncodeValue(this.normalizePath(e)).replace(/%2F/gi,"/")},e.prototype.normalizePath=function(e){var t;if("/"===e.substring(0,1)){for(t=1;"/"===e.substring(t,t+1);)t+=1;return e.substring(t)}return e},e.prototype.authorizeUrl=function(){var e;return e=this.oauth.authorizeUrlParams(this.driver.authType(),this.driver.url()),this.urls.authorize+"?"+A.Util.Xhr.urlEncode(e)},e.prototype.getAccessToken=function(e){var t,n;return t=this.oauth.accessTokenParams(this.driver.url()),n=new A.Util.Xhr("POST",this.urls.token).setParams(t).addOauthParams(this.oauth),this.dispatchXhr(n,function(t,n){return t&&t.status===A.ApiError.INVALID_PARAM&&t.response&&t.response.error&&(t=new A.AuthError(t.response)),e(t,n)})},e.prototype.dispatchLongPollXhr=function(e,t,n){return null==n&&(n=6e4),this.dispatchXhr(e,t,n)},e.prototype.dispatchXhr=function(e,t,n){var i,a,r=this;return null==n&&(n=1e4),i=setTimeout(function(){return r.handleLongRequest(e)},2*n),e.setCallback(function(e,n,a,r){return clearTimeout(i),t(e,n,a,r)}),e.onError=this.xhrOnErrorHandler,e.prepare(),a=e.xhr,this.onXhr.dispatch(e)&&e.send(),a},e.prototype.handleXhrError=function(e,t){var n=this;return e.status===A.ApiError.INVALID_TOKEN&&this.authStep===p.DONE&&(this.authError=e,this.authStep=p.ERROR,this.onAuthStepChange.dispatch(this),this.driver&&this.driver.onAuthStepChange)?(this.driver.onAuthStepChange(this,function(){return n.onError.dispatch(e),t(e)}),null):(this.onError.dispatch(e),t(e),void 0)},e.prototype.handleLongRequest=function(){return this.setupUrls()},e.prototype.defaultServerRoot=function(){return"https://api$.dropbox.com"},e.prototype.defaultAuthServer=function(){return this.serverRoot.replace("api$","www")},e.prototype.defaultFileServer=function(){return this.serverRoot.replace("api$","api-content")},e.prototype.defaultDownloadServer=function(){return"https://dl.dropboxusercontent.com"},e.prototype.defaultWsServer=function(){return this.serverRoot.replace(/^https?:/,"wss:")},e.prototype.defaultMaxApiServer=function(){return 30},e.prototype.computeCredentials=function(){var e;e=this.oauth.credentials(),this.uid&&(e.uid=this.uid),this.serverRoot!==this.defaultServerRoot()&&(e.server=this.serverRoot),this.maxApiServer!==this.defaultMaxApiServer()&&(e.maxApiServer=this.maxApiServer),this.authServer!==this.defaultAuthServer()&&(e.authServer=this.authServer),this.fileServer!==this.defaultFileServer()&&(e.fileServer=this.fileServer),this.downloadServer!==this.defaultDownloadServer()&&(e.downloadServer=this.downloadServer),this._credentials=e},e}(),p=A.Client,A.Datastore=function(){function e(e,t){var n=this;this._datastore_manager=e,this._managed_datastore=t,this._dsid=this._managed_datastore.get_dsid(),this._handle=this._managed_datastore.get_handle(),this._record_cache=new J(this),this._last_used_timestamp=0,this.recordsChanged=new A.Util.EventSource,this.syncStatusChanged=new A.Util.EventSource,this._timeoutWrapper=function(e){return e},this._evt_mgr=new N,this._evt_mgr.register(this._managed_datastore.syncStateChanged,function(){return n._syncSoon(),n.syncStatusChanged.dispatch(null)}),this._syncPending=!1,this._closed=!1,this._metadata_table=new A.Datastore.Table(this,":info"),this._metadata_table.setResolutionRule("mtime","max")}return e.prototype.recordsChanged=null,e.prototype.syncStatusChanged=null,e.int64=function(e){var t,n;if(et.is_number(e)&&null!=e[at.INT64_TAG])return at.validateInt64(e);if(et.is_string(e)){if(!at.is_valid_int64_string(e))throw new Error("Not a valid int64 in string form: "+e);return n=new Number(parseInt(e,10)),n[at.INT64_TAG]=e,at.validateInt64(n)}if(!et.is_number(e)||!isFinite(e))throw new Error("Not a finite number: "+e);if(Number(e)!==Math.round(e))throw new Error("Number is not an integer: "+e);if(t=e.toFixed(),!at.is_valid_int64_string(t))throw new Error("Number not in int64 range: "+e);return n=new Number(e),n[at.INT64_TAG]=t,at.validateInt64(n)},e.isInt64=function(e){return at.isInt64(e)},e.prototype.getModifiedTime=function(){var e;return e=this._metadata_table.getOrInsert("info",{}),e.get("mtime")},e.prototype.getTitle=function(){var e;return e=this._metadata_table.getOrInsert("info",{}),e.get("title")},e.prototype.setTitle=function(e){var t;if(null!=e&&!et.string(e))throw new Error("Title must be a string or null!");return t=this._metadata_table.getOrInsert("info",{}),t.set("title",e)},e.prototype.getTable=function(e){if(this._checkNotClosed(),!A.Datastore.Table.isValidId(e))throw new Error("Invalid table ID: "+e);return new A.Datastore.Table(this,e)},e.prototype.listTableIds=function(){return this._checkNotClosed(),this._managed_datastore.list_tables()},e.prototype.toString=function(){var e;return e=this._closed?"[closed] ":"","Datastore("+e+this._dsid+" ["+this._handle+"])"},e.prototype.close=function(){return this._closed=!0,this._evt_mgr.unregister_all(),this._listeners=[],this._datastore_manager._datasync.obj_manager.close(this._dsid),void 0},e.prototype.getId=function(){return this._dsid},e.prototype.getSyncStatus=function(){return{uploading:this._managed_datastore.get_outgoing_delta_count()>0}},e.isValidId=function(e){var t;return t=new RegExp(et.DS_ID_REGEX),et.is_string(e)&&t.test(e)},e.prototype._generateRid=function(){var e,t,n,i;for(i="_",t="_js_",n=Math.round(1e3*Date.now()),n<=this._last_used_timestamp&&(n=this._last_used_timestamp+1),this._last_used_timestamp=n,e=n.toString(32);e.length<11;)e="0"+e;return i+e+t+at.randomWeb64String(5)},e.prototype._syncSoon=function(){var e=this;if(this._managed_datastore.is_deleted())throw new Error("Cannot sync deleted datastore "+this._dsid);return this._checkNotClosed(),this._syncPending||(this._syncPending=!0,setTimeout(this._timeoutWrapper(function(){return e._syncPending=!1,e._sync()}),0)),void 0},e.prototype._sync=function(){var e,t,n,i,a,r,s,o,l;this._checkNotClosed(),a=this._managed_datastore.sync(),i=this._resolveAffectedRecordMap(a),e=!1;for(s in i)for(n=i[s],o=0,l=n.length;l>o;o++)t=n[o],it(s===t._tid,"tid mismatch"),e=!0,r=t._rid,this._managed_datastore.query(s,r)||(t._deleted=!0,this._record_cache.remove(s,r));return e&&this.recordsChanged.dispatch(new X(i,!1)),void 0},e.prototype._resolveAffectedRecordMap=function(e){var t,n,i,a,r;n={};for(r in e){a=e[r];for(i in a)t=this._record_cache.getOrCreate(r,i),null==n[r]&&(n[r]=[]),n[r].push(t)}return n},e.prototype._recordsChangedLocally=function(e){return e.length>0&&(this.recordsChanged.dispatch(X._fromRecordList(e,!0)),this._syncSoon()),void 0},e.prototype._checkNotClosed=function(){if(this._closed||!this._managed_datastore._open)throw new Error("Datastore is already closed: "+this);return void 0},e}(),at=A.Datastore.impl={},et=A.Datastore.impl.T={},et.identity=function(e){return e},et.get_coerce_fn=function(e){return null!=e.coerce?e.coerce:null!=e.load_json?function(t){return t instanceof e?t:e.load_json(t)}:et.identity},et.get_T_fn=function(e){return null!=e.Type?e.Type:e},et.str=function(e){return et.is_string(e)?e:et.is_function(e)?e():JSON.stringify(e)},et.assert=function(e,t){if(!e)throw new Error(et.str(t))},it=et.assert,et.check=function(e,t,n,i,a,r){if(e)return n;throw et.fail(t,n,i,a,r),new Error("unreachable")},et.safe_to_string=function(e){var t,n;try{if(n=e.toString(),"[object Object]"!==n)return n}catch(i){t=i}try{return JSON.stringify(e)}catch(i){t=i}try{if(n=e.constructor.name,null!=n?n.match(/^[A-Za-z0-9_]+$/):void 0)return n}catch(i){t=i}return"[T.safe_to_string failed]"},et.fail=function(e,t,n,i,a){var r,s;throw s=null!=n?null!=i?null!=a?"Wanted "+et.str(i)+", but "+et.str(n)+" in "+et.str(a)+" "+et.str(e):"Wanted "+et.str(i)+", but "+et.str(n)+" "+et.str(e):""+et.str(n)+" "+et.str(e):null!=i?null!=a?"Wanted "+et.str(i)+", but in "+et.str(a)+" "+et.str(e):"Wanted "+et.str(i)+", but "+et.str(e):""+et.str(e),r=new Error(""+s+": "+et.safe_to_string(t)),console.error(r),r},et.any=function(e){return e},et.defined=function(e,t,n,i){return null==n&&(n="defined"),et.check("undefined"!=typeof e,"is undefined",e,t,n,i),e},et.nonnull=function(e,t,n,i){return null==n&&(n="nonnull"),et.defined(e,t,n,i),et.check(null!=e,"is null",e,t,n,i),e},et.member=function(e){var t,n;return n="value in "+JSON.stringify(e),t="not in "+JSON.stringify(e),function(i,a,r,s){return null==r&&(r=n),et.check(ot.call(e,i)>=0,t,i,a,r,s)}},et.object=function(e,t,n,i){return null==n&&(n="object"),et.nonnull(e,t,n,i),et.check("object"==typeof e,"not an object",e,t,n,i),e},et.bool=function(e,t,n,i){return null==n&&(n="bool"),et.nonnull(e,t,n,i),et.check(e===!0||e===!1,"is not bool",e,t,n,i),e},et.string=function(e,t,n,i){return null==n&&(n="string"),et.nonnull(e,t,n,i),et.check(et.is_string(e),"is not a string",e,t,n,i),e},et.num=function(e,t,n,i){return null==n&&(n="num"),et.nonnull(e,t,n,i),et.check("number"==typeof e,"is not numeric",e,t,n,i),e},et.int=function(e,t,n,i){return null==n&&(n="int"),et.num(e,t,n,i),et.check(0===e%1,"is not an integer",e,t,n,i),e},et.uint=function(e,t,n,i){return null==n&&(n="uint"),et.int(e,t,n,i),et.check(e>=0,"is negative",e,t,n,i),e},et.nullable=function(e){var t,n;return n="nullable("+e+")",t=function(t,i,a,r){return null==a&&(a=function(){return n}),et.defined(t,i,a,r),null!=t&&et.get_T_fn(e)(t,i,a,r),t},t.toString=function(){return n},t.coerce=function(t){return null!=t?et.get_coerce_fn(e)(t):null},t.fromJSON=function(n){return null!=n?null!=e.fromJSON?e.fromJSON(n):t.coerce(n):null},t},et.array=function(e,t,n,i){return null==n&&(n="array"),et.nonnull(e,t,n,i),et.check(et.is_array(e),"is not an array",e,t,n,i),e},et.arrayOf=function(e){var t,n;return n="arrayOf("+e+")",t=function(t,i,a,r){var s,o,l,c,d;for(null==a&&(a=n),et.array(t,i,a,r),l=c=0,d=t.length;d>c;l=++c)s=t[l],o=function(){return null!=i?"element "+l+" of "+et.str(i):"element "+l},et.get_T_fn(e)(s,o,a,r);return t},t.toString=function(){return n},t.coerce=function(t){var i,a,r,s;for(et.array(t,null,n),s=[],a=0,r=t.length;r>a;a++)i=t[a],s.push(et.get_coerce_fn(e)(i));return s},t.fromJSON=function(i){var a,r,s,o;if(et.array(i,"fromJSON input",n),null!=e.fromJSON){for(o=[],r=0,s=i.length;s>r;r++)a=i[r],o.push(e.fromJSON(a));return o}return t.coerce(i)},t},et.instance=function(e,t,n,i,a){var r;if(!(t instanceof Function))throw new Error("Invalid type given: "+t);return e instanceof t||(null==i&&(i=t.name),et.check(!1,"got instance of "+(null!=e?null!=(r=e.constructor)?r.name:void 0:void 0),e,n,i,a)),e},et.unimplemented=function(e){return function(){throw new Error("unimplemented "+e)}},et.startsWith=function(e,t){return 0===e.lastIndexOf(t,0)},et.string_matching=function(e){var t;return et.string(e),et.check(/^[^].*[$]$/.test(e),"does not start with ^ and end with $",e),t="does not match regex "+e,function(n,i,a,r){return et.string(n,i,a,r),et.check(new RegExp(e).test(n),t,n,i,a,r),n}},et.is_defined=function(e){return"undefined"!=typeof e},et.is_bool=function(e){return e===!0||e===!1||e&&"object"==typeof e&&e.constructor===Boolean},et.is_number=function(e){return"number"==typeof e||e&&"object"==typeof e&&e.constructor===Number},et.is_json_number=function(e){return et.is_number(e)&&!isNaN(e)&&isFinite(e)},et.is_string=function(e){return"string"==typeof e||e&&"object"==typeof e&&e.constructor===String},et.is_function=function(e){return"function"==typeof e},et.is_object=function(e){return null!=e&&"object"==typeof e},et.is_array=function(e){return"[object Array]"===Object.prototype.toString.call(e)},et.is_empty=function(e){return 0===Object.keys(e).length},et.is_date=function(e){return"[object Date]"===Object.prototype.toString.call(e)},et.isUint8Array=function(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)},et.is_simple_map=function(e){var t,n;if(null==e||"object"!=typeof e)return!1;for(t in e)if(n=e[t],!Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},et.simple_map=function(e,t,n,i){var a,r;null==n&&(n="simple map"),et.object(e,t,n,i);for(a in e)r=e[a],et.check(Object.prototype.hasOwnProperty.call(e,a),function(){return"property "+a+" is inherited"},e,t,n,e);return e},et.simple_typed_map=function(e,t,n){var i,a,r;return i=et.get_coerce_fn(t),a=et.get_coerce_fn(n),r=function(i,a,r,s){var o,l;null==r&&(r=e),et.simple_map(i,a,r,s);for(o in i)l=i[o],et.get_T_fn(t)(o,"property",null,i),et.get_T_fn(n)(l,function(){return"value of property "+o},null,i);return i},r.coerce=function(t){var n,r,s;et.simple_map(t,null,e),r={};for(n in t)s=t[n],r[i(n)]=a(s);return r},r.fromJSON=function(t){var a,r,s;et.simple_map(t,null,e),r={};for(a in t)s=t[a],r[i(a)]=null!=n.fromJSON?n.fromJSON(s):s;return r},r},et.DS_ID_REGEX="^[-_a-z0-9]([-_a-z0-9.]{0,30}[-_a-z0-9])?$|^[.][-_a-zA-Z0-9]{1,100}$",et.dsid=function(e,t,n,i){return null==n&&(n="dsid"),et.string_matching(et.DS_ID_REGEX)(e,t,n,i),e},et.SS_ID_REGEX="^[-:._+/=a-zA-Z0-9][-._+/=a-zA-Z0-9]{0,31}$",et.tid=function(e,t,n,i){return null==n&&(n="tid"),et.string_matching(et.SS_ID_REGEX)(e,t,n,i),e},et.rowid=function(e,t,n,i){return null==n&&(n="rowid"),et.string_matching(et.SS_ID_REGEX)(e,t,n,i),e},et.field_name=function(e,t,n,i){return null==n&&(n="field name"),et.string_matching(et.SS_ID_REGEX)(e,t,n,i),e},function(){var e,t,n;n=[];for(e in et)t=et[e],et.hasOwnProperty(e)?n.push(function(e){return t.toString=function(){return"T."+e}}(e)):n.push(void 0);return n}(),at.struct=rt={},rt.define=function(e,t){var n,i,a,r,s,o,l,c,d,h,u,p,f,m,g,b;for(et.string(e,"struct name"),et.array(t,"fields"),m=[],f={},s=g=0,b=t.length;b>g;s=++g){a=t[s],et.array(a,"field","field descriptor",t),et.check(2<=a.length&&a.length<=3,"does not have length 2 or 3",a,"field descriptor"),h=et.string(a[0],"field name","field descriptor",t),p=et.nonnull(a[1],"field type","field descriptor",t),u=a.length<=2?{}:et.nonnull(a[2],"map of field options","field descriptor",t);for(c in u)"init"!==c&&"initFn"!==c&&et.fail("unknown option "+c,u,"field options","field descrptor",t);ot.call(u,"init")>=0&&ot.call(u,"initFn")>=0&&et.fail("both 'init' and 'initFn' specified",u,"field options","field descriptor",t),l="initFn"in u?u.initFn:"init"in u?(o=u.init,function(e){return function(){return e}}(o)):null,n={name:h,type:p,initFn:l},r="undefined"!=typeof Y&&null!==Y?new Y(n):n,m.push(r),f[h]=r}return d="initializer for "+e+" (fields "+function(){var e,t,n;for(n=[],e=0,t=m.length;t>e;e++)a=m[e],n.push(a.name);return n}().join(", ")+")",i=function(e){var t,n,a;et.defined(e,"x","initializer");for(h in e)t=e[h],e.hasOwnProperty(h)&&et.check(null!=f[h],function(){return"has an unexpected field "+h},e,"initializer");for(n=0,a=m.length;a>n;n++)r=m[n],e[r.name]&&!e.hasOwnProperty(r.name)&&et.fail("Has an indirect property "+r.name,e,"initializer"),e.hasOwnProperty(r.name)?(t=e[r.name],this[r.name]=et.get_coerce_fn(r.type)(t)):null!=r.initFn?this[r.name]=r.initFn():et.fail("lacks the field "+r.name,e,"initializer");return i.Type(this,"initializer",d,this),this},i.Type=function(t,n,a,s){var o,l,c;for(et.defined(t,n,a,s),et.check(t instanceof i,function(){return"is not an instance of "+e},t,n,a,s),l=0,c=m.length;c>l;l++)r=m[l],et.check(t.hasOwnProperty(r.name),function(){return"lacks the field "+r.name},t,n,a,s),et.get_T_fn(r.type)(t[r.name],r.name,a,s);for(h in t)o=t[h],t.hasOwnProperty(h)&&et.check(null!=f[h],"has an unexpected field",h,n,a,s);return t},i.coerce=function(e){return e instanceof i?(i.Type(e),e):new i(e)},i.prototype.toString=function(){var e,t,n,i,a;for(t=this,e=[],i=0,a=m.length;a>i;i++)r=m[i],n=t[r.name],e.push(""+r.name+": "+(et.is_object(n)&&et.is_function(n.toString)?n.toString():JSON.stringify(n)));return"{"+e.join(", ")+"}"},i.prototype.toJSON=function(){var e,t,n,i;for(e=this,t=function(){return""+e},n=0,i=m.length;i>n;n++)r=m[n],et.get_T_fn(r.type)(this[r.name],r.name,null,t);return this},i.fromJSON=function(t){var n,a,r;et.simple_map(t,"input"),a=[];for(c in t)r=t[c],null==f[c]&&(a.push(""+c+": "+JSON.stringify(r)),delete t[c]);a.length>0&&console.info("Ignoring unknown fields while deserializing "+e+": "+a.join(", ")),n={};for(c in t)r=t[c],p=f[c].type,n[c]=null!=p.fromJSON?p.fromJSON(r):r;return new i(n)},i.toString=function(){return"struct "+e},i},Y=rt.define("StructField",[["name",et.string],["type",et.defined],["initFn",et.defined]]),rt.toJSO=function(e){var t,n,i,a;if("object"!=typeof e)return e;if(et.is_array(e))return function(){var n,i,a;for(a=[],n=0,i=e.length;i>n;n++)t=e[n],a.push(rt.toJSO(t));return a}();i={};for(n in e)a=e[n],e.hasOwnProperty(n)&&(i[n]=rt.toJSO(a));return i},rt.union_as_list=function(e,t){var n,i,a,r,s,o,l,c,d,h,u;for(et.string(e,"union name"),et.array(t,"variants"),i=function(){throw new Error("Use "+e+".from_array instead")},c={},l=[],d=function(t,n,a){var r;return r=rt.define(""+e+"."+t,a),r.prototype.tag=function(){return t},r.prototype.toString=function(){return""+e+"."+t+"("+JSON.stringify(this)+")"},r.prototype.toJSON=function(){var e,i,a,r,s,o;for(e=[t],s=0,o=n.length;o>s;s++)i=n[s],a=i[0],r=i[1],et.get_T_fn(r)(this[a],a),e.push(this[a]);return e},r.from_array=function(i){var a,s,o,l,c,d,h;for(c="initializer for "+e,et.array(i,"initializer",c),et.check(i.length===n.length+1,"does not have length "+(n.length+1),i,"initializer",c),et.check(i[0]===t,"does not have tag "+t,i,"initializer",c),a={_tag:t},o=d=0,h=n.length;h>d;o=++d)s=n[o],l=s[0],a[l]=i[o+1];return new r(a)},r.fromJSON=function(e){return e.length>n.length+1&&(e=e.slice(0,n.length+1)),r.from_array(e)},r.coerce=function(e){return e instanceof r?(r.Type(e),e):r.from_array(e)},c[t]=r,i[t]=r},h=0,u=t.length;u>h;h++)a=t[h],et.array(a,"variant","variant descriptor",t),et.check(2===a.length,"does not have length 2",a,"variant descriptor",t),o=et.string(a[0],"tag","tag",t),r=et.array(a[1],"fields","variant descriptor",t),s=r.slice(0),s.unshift(["_tag",et.member([o])]),d(o,r,s),l.push(o);return n="initializer for "+e+" (variants "+l.join(", ")+")",i.from_array=function(t){var n,i;return i="initializer for "+e,et.array(t,"initializer",i),et.check(t.length>=1,"lacks a tag",t,"initializer",i),n=t[0],et.string(n,"tag",i,t),et.member(l)(n),c[n].from_array(t)},i.fromJSON=function(t){var n,i;return i="initializer for "+e,et.array(t,"initializer",i),et.check(t.length>=1,"lacks a tag",t,"initializer",i),n=t[0],et.string(n,"tag",i,t),et.member(l)(n),c[n].fromJSON(t)},i.Type=function(t,n,i,a){var r;return null==i&&(i=""+e+".Type"),et.defined(t,n,i,a),et.defined(t.tag,"tag",i,a),r=t.tag(),et.string(r,"tag","initializer",t),et.member(l)(r),c[r].Type(t,null,"object of type "+e),t},i.coerce=function(e){var t,n;for(n in c)if(t=c[n],e instanceof t)return t.Type(e),e;return i.from_array(e)},i.toString=function(){return"union "+e},i},at.nonzero_int64_approximate_regex=new RegExp("^-?[1-9][0-9]{0,18}$"),at.int64_max_str="9223372036854775807",at.int64_min_str="-9223372036854775808",at.int64_string_less_than=function(e,t){var n,i,a;return e===t?!1:(i="0"===e.charAt(0),a="0"===t.charAt(0),i&&!a?!0:a&&!i?!1:(n=e.length===t.length?e>t:e.length>t.length,i&&a?n:!n))},at.is_valid_int64_string=function(e){return et.is_string(e)?"0"===e?!0:at.nonzero_int64_approximate_regex.test(e)?"-"===e.charAt(0)?e.length<at.int64_min_str.length||e<=at.int64_min_str:e.length<at.int64_max_str.length||e<=at.int64_max_str:!1:!1},at.is_wrapped_atomic_field_value=function(e){var t,n,i,a;if(!et.is_simple_map(e))return!1;if(t=Object.keys(e),1!==t.length)return!1;switch(t[0]){case"B":return et.is_string(e.B);case"N":return"nan"===(i=e.N)||"+inf"===i||"-inf"===i;case"I":case"T":return n=null!=(a=e.I)?a:e.T,at.is_valid_int64_string(n);default:return!1}},at.is_atomic_field_value=function(e){return et.is_bool(e)||et.is_json_number(e)||et.is_string(e)||at.is_wrapped_atomic_field_value(e)},at.is_list_value=function(e){var t,n,i;if(et.is_array(e)){for(n=0,i=e.length;i>n;n++)if(t=e[n],!at.is_atomic_field_value(t))return!1;return!0}return!1},at.is_compound_field_value=function(e){return at.is_atomic_field_value(e)||at.is_list_value(e)},at.atomic_field_value=function(e,t,n,i){return null==n&&(n="atomic field value"),et.check(at.is_atomic_field_value(e),"is not an atomic field value",e,t,n,i),e},at.list_value=function(e,t,n,i){return null==n&&(n="list value"),et.arrayOf(at.atomic_field_value)(e,t,n,i),e},at.compound_field_value=function(e,t,n,i){return null==n&&(n="field value"),et.is_array(e)?at.list_value(e,t,n,i):at.atomic_field_value(e,t,n,i)},at.FieldOp=M=rt.union_as_list("FieldOp",[["P",[["value",at.compound_field_value]]],["D",[]],["LC",[]],["LP",[["at",et.uint],["value",at.atomic_field_value]]],["LI",[["before",et.uint],["value",at.atomic_field_value]]],["LD",[["at",et.uint]]],["LM",[["from",et.uint],["to",et.uint]]]]),at.datadict=et.simple_typed_map("datadict",et.field_name,at.compound_field_value),at.update_datadict=et.simple_typed_map("update_datadict",et.field_name,M),at.Change=i=rt.union_as_list("Change",[["I",[["tid",et.tid],["rowid",et.rowid],["fields",at.datadict]]],["U",[["tid",et.tid],["rowid",et.rowid],["updates",at.update_datadict]]],["D",[["tid",et.tid],["rowid",et.rowid]]]]),at.Delta=T=rt.define("Delta",[["rev",et.uint],["changes",et.arrayOf(i)],["nonce",et.string]]),F=rt.define("ListDatastoresResponseItem",[["dsid",et.string],["handle",et.string],["rev",et.uint],["info",et.nullable(at.datadict),{init:null}]]),O=rt.define("ListDatastoresResponse",[["token",et.string],["datastores",et.arrayOf(F)]]),R=rt.define("GetSnapshotResponseRow",[["tid",et.string],["rowid",et.string],["data",at.datadict]]),B=rt.define("GetSnapshotResponse",[["rev",et.uint],["rows",et.arrayOf(R)]]),s=rt.define("CreateDatastoreResponse",[["handle",et.string],["rev",et.uint],["created",et.bool]]),S=rt.define("GetDatastoreResponse",[["handle",et.string],["rev",et.uint]]),D=rt.define("DeleteDatastoresResponse",[]),V=rt.define("PutDeltasResponse",[["rev",et.nullable(et.uint),{init:null}],["conflict",et.nullable(et.string),{init:null}]]),P=rt.define("GetDeltasResponse",[["deltas",et.nullable(et.arrayOf(T)),{init:null}],["notfound",et.nullable(et.string),{init:null}]]),t=rt.define("AwaitResponseDeltas",[["deltas",et.simple_typed_map("deltas map",et.string,P)]]),at.AwaitResponse=e=rt.define("AwaitResponse",[["get_deltas",et.nullable(t),{init:null}],["list_datastores",et.nullable(O),{init:null}]]),d=function(){function e(e){this.obj_manager=t(e)}var t;return t=function(e){var t,n;return n=new x(e),t=new z(n,e)},e.changeFromArray=function(e){return i.from_array(e)},e.prototype.close=function(){return this.obj_manager.destroy()},e.prototype.get_or_create=function(e,t){var n=this;return this.obj_manager.flob_client.get_or_create_db(e,function(i,a){return i?t(i):n.obj_manager.open(e,a.handle,function(e,n){return null!=e?t(e):t(null,n,a.created)})})},e.prototype.create=function(e,t,n){var i=this;return this.obj_manager.flob_client.create_db(e,t,function(t,a){return t?n(t):i.obj_manager.open(e,a.handle,function(e,t){return null!=e?n(e):n(null,t,a.created)})})},e.prototype.get_by_dsid=function(e,t){var n=this;return this.obj_manager.flob_client.get_db(e,function(i,a){return i?t(i):n.obj_manager.open(e,a.handle,function(e,n){return null!=e?t(e):t(null,n)})})},e.prototype.get=function(e,t){return this.obj_manager.open(e,function(e,n){return null!=e?t(e):t(null,n)})},e}(),n=function(){function e(){this.min_delay_millis=500,this.max_delay_millis=9e4,this.base=1.5,this._failures=0,this.log=!1}return e.prototype.set_log=function(e){this.log=e},e.prototype.set_max_delay_millis=function(e){this.max_delay_millis=e},e.prototype.get_backoff_millis=function(){var e,t;return this._failures+=1,t=Math.min(this.max_delay_millis,this.min_delay_millis*Math.pow(this.base,this._failures-1)),e=(.5+Math.random())*t,this.log&&console.log("get_backoff_millis: failures="+this._failures+", target_delay_millis="+t+", delay_millis="+e),e},e.prototype.reset=function(){return this._failures=0},e}(),K=function(){function e(){this.backoff=new n}var t,i;return i=6e4,t=0,e.prototype.run=function(e,t,n){var a,r,s,o,l,c,d,h=this;return s=null!=(c=t.do_retry)?c:function(){return!0},o=null!=(d=t.giveup_after_ms)?d:i,l=Date.now()+o,r=!1,a=function(){return r?void 0:e(function(){var e,t,i;return e=arguments[0],t=2<=arguments.length?ct.call(arguments,1):[],r?void 0:e&&s(e)?Date.now()>l?(console.error("Giving up due to error",e),n(e)):(i=h.backoff.get_backoff_millis(),console.warn("Retrying in "+i+" ms due to error",e),setTimeout(a,i)):n.apply(null,[e].concat(ct.call(t)))})},a(),function(){return r=!0}},e}(),C=function(){function e(e){this.client=e,this._retry=new K}var t,n;return n=10,t=2419200,e.prototype._run_with_retries=function(e,t,n){var i;return i={giveup_after_ms:1e3*e,do_retry:function(e){var t;return 0===e.status||500<=(t=e.status)&&600>t}},this._retry.run(n,i,t)},e.prototype.delete_db=function(e,t){var i=this;return this._run_with_retries(n,t,function(t){return i.client._deleteDatastore(e,function(e){return null!=e?t(e):t(null)})})},e.prototype.list_dbs=function(e){var n=this;return this._run_with_retries(t,e,function(e){return n.client._listDatastores(function(t,n){return null!=t?e(t):e(null,n)})})},e.prototype.get_or_create_db=function(e,t){var i=this;return this._run_with_retries(n,t,function(t){return i.client._getOrCreateDatastore(e,function(e,n){return null!=e?t(e):t(null,n)})})},e.prototype.create_db=function(e,t,i){var a=this;return this._run_with_retries(n,i,function(n){return a.client._createDatastore(e,t,function(e,t){return null!=e?n(e):n(null,t)})})},e.prototype.get_db=function(e,t){var i=this;return this._run_with_retries(n,t,function(t){return i.client._getDatastore(e,function(e,n){return null!=e?t(e):t(null,n)})})},e.prototype.await=function(e,n,i){var a,r=this;return a=this._run_with_retries(t,i,function(t){return r.client._datastoreAwait(e,n,function(e,n){return null!=e?t(e):t(null,n)})})},e.prototype.put_delta=function(e,n,i){var a,r=this;return a=function(e,t){return i(t)},this._run_with_retries(t,i,function(t){return r.client._putDelta(e,n,function(e){return null!=e?t(e):t(null)})})},e.prototype.get_snapshot=function(e,t){var i=this;return this._run_with_retries(n,t,function(t){return i.client._getSnapshot(e,function(e,n){return null!=e?t(e):t(null,n)})})},e}(),H=function(){function e(e,t,n){this.changes=e,this.undo_extras=t,this.finalized=null!=n?n:!1}var t;return t=function(e,t){var n,a,r,s,o;switch(s=null,a=null,e.tag()){case"I":s="D";break;case"U":s="U",a={};for(r in t)o=t[r],a[r]=null==o?["D"]:["P",o];break;case"D":s="I",a=at.clone(t);break;default:throw new Error("Unknown change tag: "+e.tag())}return n=[s,e.tid,e.rowid],null!=a&&n.push(a),i.from_array(n)},e.prototype.add_change=function(e,t){return it(!this.finalized,"add_change: already finalized"),this.changes.push(e),this.undo_extras.push(t)},e.prototype["package"]=function(e,t){return it(this.finalized,"package: not finalized"),new T({changes:this.changes.slice(),nonce:e,rev:t})},e.prototype.inverse_changes=function(){var e,n,i,a,r,s;for(i=[],s=this.changes,n=a=0,r=s.length;r>a;n=++a)e=s[n],i.push(t(e,this.undo_extras[n]));return i.reverse(),i},e}(),at.value_size=function(e){var t,n,i,a;if(et.is_string(e))return A.Util.countUtf8Bytes(e);if(et.is_bool(e))return 0;if(et.is_number(e))return 0;if(et.is_array(e)){for(t=20*e.length,i=0,a=e.length;a>i;i++)n=e[i],t+=at.value_size(n);return t}if("object"!=typeof e)throw new Error("Unexpected value: "+e);if(null!=e.I)return 0;if(null!=e.N)return 0;if(null!=e.B)return Math.ceil(3*e.B.length/4);if(null!=e.T)return 0;throw new Error("Unexpected object: "+JSON.stringify(e))},j=102400,L=10485760,q=2097152,at.size_difference_for_field_op=function(e,t,n){var i,a,r,s;switch(i=e.get(t),n.tag()){case"P":return a=n.value,i?at.value_size(a)-at.value_size(i):100+at.value_size(a);case"D":return null!=i?-(100+at.value_size(i)):0;case"LC":return it(null==i,"can't create list for field that already exists"),100;case"LP":return it(et.is_array(i),"LP on non-list"),it(0<=(r=n.at)&&r<i.length,"bad index for LP"),at.value_size(n.value)-at.value_size(i[n.at]);case"LI":return null!=i?20+at.value_size(n.value):120+at.value_size(n.value);case"LD":return it(et.is_array(i),"LD on non-list"),it(0<=(s=n.at)&&s<i.length,"bad index for LD"),-(20+at.value_size(i[n.at]));case"LM":return 0;default:throw new Error("unexpected field op type "+n.tag())}},at.size_difference_for_change=function(e,t){var n,i,a,r,s,o,l;return s=function(){var s,c;switch(t.tag()){case"I":r=100,s=t.fields;for(n in s)l=s[n],r+=100+at.value_size(l);return r;case"U":a=e.get_record(t.tid,t.rowid),et.assert(null!=a,function(){return"record not found: "+JSON.stringify(t)}),o=0,c=t.updates;for(n in c)i=c[n],o+=at.size_difference_for_field_op(a,n,i);return o;case"D":return-e.get_record(t.tid,t.rowid)._size;default:throw new Error("unrecognized tag "+t.tag())}}()},$=function(){function e(e,t,n){var i,a;this._tid=e,this._rid=t,null==n&&(n={}),this._fields={},this._size=100;for(i in n)a=n[i],this._fields[i]=at.clone(a),this._size+=100+at.value_size(a)}return e.prototype.get=function(e){return this._fields[e]},e.prototype.get_all=function(){return this._fields},e.prototype.put=function(e,t){return null!=t?this._fields[e]=at.clone(t):delete this._fields[e],void 0},e.prototype.apply_field_op=function(e,t){var n,i,a,r,s,o,l;switch(n=this._fields[e],t.tag()){case"P":this._fields[e]=at.clone(t.value);break;case"D":delete this._fields[e];break;case"LC":it(null==n,"can't create list for field that already exists"),this._fields[e]=[];break;case"LP":it(et.is_array(n),"LP on non-list"),it(0<=(a=t.at)&&a<n.length,"bad index for LP"),n[t.at]=at.clone(t.value);break;case"LI":null!=n?(it(et.is_array(n),"LI on non-list"),it(0<=(r=t.before)&&r<=n.length,"bad index for LI"),n.splice(t.before,0,at.clone(t.value))):(it(0===t.before,"bad index for LI on nonexistent field"),this._fields[e]=[at.clone(t.value)]);break;case"LD":it(et.is_array(n),"LD on non-list"),it(0<=(s=t.at)&&s<n.length,"bad index for LD"),n.splice(t.at,1);break;case"LM":it(et.is_array(n),"LM on non-list"),it(0<=(o=t.from)&&o<n.length,"bad from index for LM"),it(0<=(l=t.to)&&l<n.length,"bad to index for LM"),i=n[t.from],n.splice(t.from,1),n.splice(t.to,0,i);break;default:throw new Error("unexpected field op type "+t.tag())}return void 0},e}(),tt=function(){function e(){this._records={}}return e.prototype.get=function(e){return this._records[e]},e.prototype.put=function(e,t){return null!=t?this._records[e]=t:delete this._records[e],void 0},e.prototype.has=function(e){return null!=this._records[e]},e.prototype.is_empty=function(){var e;for(e in this._records)return!1;return!0},e.prototype.list_record_ids=function(){var e,t;t=[];for(e in this._records)t.push(e);return t},e}(),c=function(){function e(e,t){var n,i,a,r,s,o;this._tables={},this._size=1e3;for(o in t){a=t[o],s=this._get_table(o);for(r in a)n=a[r],i=new $(o,r,n),this._check_record_size(e,o,r,i._size),s.put(r,i),this._size+=i._size}this._check_datastore_size(e,this._size)}return e.from_get_snapshot_resp=function(t){var n,i,a,r,s,o;for(n={},o=t.rows,a=0,r=o.length;r>a;a++)i=o[a],n[s=i.tid]||(n[s]={}),n[i.tid][i.rowid]=i.data;return new e(!1,n)},e.prototype._size_limit_exceeded=function(e,t){var n;if(e)throw n=new Error(t),n.code="SIZE_LIMIT_EXCEEDED",n;return console.warn(t),void 0},e.prototype._check_record_size=function(e,t,n,i){return i>j&&this._size_limit_exceeded(e,"Record ("+t+", "+n+") too large: "+i+" bytes"),void 0},e.prototype._check_datastore_size=function(e,t){return t>L&&this._size_limit_exceeded(e,"Datastore too large: "+t+" bytes"),void 0},e.prototype._TEST_calculate_size_from_scratch=function(){var e,t,n,i,a,r,s,o,l,c,d,h;i=0,c=this._tables;for(r in c)for(a=c[r],d=a.list_record_ids(),o=0,l=d.length;l>o;o++){n=d[o],t=a.get(n),i+=100,h=t.get_all();for(e in h)s=h[e],i+=100+at.value_size(s)}return i},e.prototype.raw_data=function(){var e,t,n,i,a,r,s,o;e={},s=this._tables;for(i in s)for(n=s[i],e[i]={},o=n.list_record_ids(),a=0,r=o.length;r>a;a++)t=o[a],e[i][t]=at.clone(n.get(t).get_all());return e},e.prototype.get_record=function(e,t){var n;return null!=(n=this._tables[e])?n.get(t):void 0},e.prototype.apply_change=function(e,t){var n,i,a;switch(n=at.size_difference_for_change(this,t),n>=0&&this._check_datastore_size(e,this._size+n),t.tag()){case"I":this._check_record_size(e,t.tid,t.rowid,n),a=this._apply_insert(t);break;case"U":i=this.get_record(t.tid,t.rowid),et.assert(null!=i,function(){return"apply_change: record does not exist: "+JSON.stringify(t)}),n>=0&&this._check_record_size(e,t.tid,t.rowid,i._size+n),a=this._apply_update(i,t),i._size+=n;break;case"D":a=this._apply_delete(t);
break;default:throw new Error("unrecognized tag "+t.tag())}return this._size+=n,a},e.prototype._get_table=function(e){return null==this._tables[e]&&(this._tables[e]=new tt),this._tables[e]},e.prototype._apply_insert=function(e){var t,n;return n=this._get_table(e.tid),et.assert(!n.has(e.rowid),function(){return"_apply_insert: record already exists: "+JSON.stringify(e)}),t=new $(e.tid,e.rowid,e.fields),n.put(e.rowid,t),null},e.prototype._apply_update=function(e,t){var n,i,a,r,s,o,l;r={};try{o=t.updates;for(i in o)a=o[i],s=at.clone(null!=(l=e.get(i))?l:null),e.apply_field_op(i,a),r[i]=s}catch(c){n=c;for(i in r)s=r[i],e.put(!1,i,s);throw n}return r},e.prototype._apply_delete=function(e){var t,n,i;return i=this._get_table(e.tid),et.assert(i.has(e.rowid),function(){return"_apply_delete: record does not exist: "+JSON.stringify(e)}),n=i.get(e.rowid),t=at.clone(n.get_all()),i.put(e.rowid,null),i.is_empty()&&delete this._tables[e.tid],t},e.prototype.query=function(e,t){var n,i;return i=this._tables[e],null==i?null:(n=i.get(t),null==n?null:at.clone(n.get_all()))},e.prototype.list_tables=function(){var e,t;return e=function(){var e;e=[];for(t in this._tables)e.push(t);return e}.call(this),e.sort(),e},e.prototype.list_rows_for_table=function(e){var t,n;return n=this._tables[e],null==n?[]:(t=n.list_record_ids(),t.sort(),t)},e.prototype.size=function(){return this._size},e}(),U=function(){function e(e,t,n,i,a,r){this.dbid=e,this.handle=t,this.datastore_model=n,this.resolver=i,this.sync_state=a,this.flob_client=r,this.syncStateChanged=new A.Util.EventSource,this._deleted=!1,this._open=!0,this._commit_queue=new Q}return e.fresh_managed_datastore=function(t,n,i,a,r,s){var o,l;return o=at.randomWeb64String(10),l=new Z(o,null,a,[],[]),new e(t,n,i,r,l,s)},e.prototype.get_dsid=function(){return this.dbid},e.prototype.get_handle=function(){return this.handle},e.prototype.is_deleted=function(){return this._deleted},e.prototype.mark_deleted=function(){return this._deleted=!0},e.prototype.open=function(){if(this._open)throw new Error("Attempt to open datastore multiple times");return this._open=!0},e.prototype.close=function(){if(!this._open)throw new Error("Attempt to close datastore multiple times");return this._open=!1},e.prototype._do_sync=function(){var e,t,n,i,a,r,s,o,l,c,d,h,u,p,f,m,g,b,v,y,_,E,k;if(0===this.sync_state.server_deltas.length)return{};for(a=this.resolver.resolve(this.sync_state.unsynced_deltas,this.sync_state.server_deltas),i=a.rebased_deltas,e=a.affected_records,r=this.sync_state.unsynced_deltas.slice().reverse(),o=0,h=r.length;h>o;o++)for(n=r[o],y=n.inverse_changes(),l=0,u=y.length;u>l;l++)t=y[l],this.datastore_model.apply_change(!1,t);for(_=this.sync_state.server_deltas,c=0,p=_.length;p>c;c++)for(n=_[c],E=n.changes,d=0,f=E.length;f>d;d++)t=E[d],this.datastore_model.apply_change(!1,t);for(b=0,m=i.length;m>b;b++)for(n=i[b],n.undo_extras=[],k=n.changes,v=0,g=k.length;g>v;v++)t=k[v],s=this.datastore_model.apply_change(!1,t),n.undo_extras.push(s);return this.sync_state.update_unsynced_deltas(i),e},e.prototype._do_commit=function(){var e,t=this;return this.sync_state.delta_pending()||(e=this.sync_state.get_next_commit(),null==e)?void 0:this._commit_queue.request(function(){return t.flob_client.put_delta(t.handle,e,function(){return t._commit_queue.finish()})})},e.prototype._apply_and_queue_local_change=function(e,t){var n;return n=this.datastore_model.apply_change(e,t),this.sync_state.add_unsynced_change(t,n),void 0},e.prototype._update_mtime=function(){return null},e.prototype.perform_local_change=function(e){return this._apply_and_queue_local_change(!0,e),this._update_mtime(),this.syncStateChanged.dispatch(null)},e.prototype.sync=function(){var e;return this.has_unfinalized_changes&&this.sync_state.finalize(),e=this._do_sync(),this._do_commit(),e},e.prototype.get_outgoing_delta_count=function(){return this.sync_state.unsynced_deltas.length},e.prototype.get_incoming_delta_count=function(){return this.sync_state.server_deltas.length},e.prototype.has_unfinalized_changes=function(){return this.sync_state.has_unfinalized_changes()},e.prototype.receive_server_delta=function(e){return this.sync_state.receive_server_delta(e)?this.syncStateChanged.dispatch(null):this.syncStateChanged.dispatch(null)},e.prototype.query=function(e,t){return this.datastore_model.query(e,t)},e.prototype.list_tables=function(){var e;return function(){var t,n,i,a;for(i=this.datastore_model.list_tables(),a=[],t=0,n=i.length;n>t;t++)e=i[t],":info"!==e&&a.push(e);return a}.call(this)},e.prototype.list_rows_for_table=function(e){return this.datastore_model.list_rows_for_table(e)},e}(),Z=function(){function e(e,t,n,i,a){this.last_nonce=e,this.pending_delta=t,this.last_rev=n,this.unsynced_deltas=i,this.server_deltas=a,et.uint(this.last_rev,"last_rev")}return e.prototype.is_current=function(){return 0===this.unsynced_deltas.length&&0===this.server_deltas.length},e.prototype.add_unsynced_change=function(e,t){var n;return n=this.unsynced_deltas.length,0===n||this.unsynced_deltas[n-1].finalized?this.unsynced_deltas.push(new H([e],[t])):this.unsynced_deltas[n-1].add_change(e,t)},e.prototype._compact_deltas=function(){var e,t,n,i,a,r,s,o,l,c,d,h,u,p;if(i=this.unsynced_deltas.length,!(1>=i)){for(t=[],r=[],n=s=0,h=i-1;h>=0?h>s:s>h;n=h>=0?++s:--s){for(u=this.unsynced_deltas[n].changes,o=0,c=u.length;c>o;o++)e=u[o],t.push(e);for(p=this.unsynced_deltas[n].undo_extras,l=0,d=p.length;d>l;l++)a=p[l],r.push(a)}return this.unsynced_deltas=[new H(t,r,!0),this.unsynced_deltas[i-1]]}},e.prototype.get_next_commit=function(){var e,t,n;return it(null==this.pending_delta,"delta pending"),e=this.unsynced_deltas.length,0===e?null:(this._compact_deltas(),t=this.unsynced_deltas[0],t.finalized?(n=this.last_nonce,this.pending_delta=t["package"](n,this.last_rev),this.pending_delta):null)},e.prototype.clear_pending=function(){return this.pending_delta=null},e.prototype.delta_pending=function(){return null!=this.pending_delta},e.prototype.has_unfinalized_changes=function(){var e,t;return t=this.unsynced_deltas.length,0===t?!1:(e=this.unsynced_deltas[t-1],!e.finalized)},e.prototype.finalize=function(){var e;return this.has_unfinalized_changes()?(e=this.unsynced_deltas[this.unsynced_deltas.length-1],it(!e.finalized,"last delta already finalized"),e.finalized=!0):void 0},e.prototype.update_unsynced_deltas=function(e){return this.unsynced_deltas=e,this.last_rev+=this.server_deltas.length,this.server_deltas=[]},e.prototype.is_ours=function(e){return this.last_nonce===e.nonce},e.prototype.ack=function(e){return it(this.is_ours(e),"not ours"),it(null!=this.pending_delta,"no pending delta"),it(0===this.server_deltas.length,"server deltas exist"),this.pending_delta=null,this.unsynced_deltas.shift(),this.last_rev++},e.prototype.receive_server_delta=function(e){var t,n;return n=this.server_deltas.length,t=n>0?this.server_deltas[n-1].rev+1:this.last_rev,it(e.rev<=t,"was expecting rev "+t+", but got "+e.rev+" instead!"),e.rev<t?(console.warn("received old delta!"),!1):this.is_ours(e)?(this.ack(e),!1):(this.server_deltas.push(e),this.pending_delta=null,!0)},e}(),at.DatastoreModel=c,W=function(){function e(e){this.update_manager=e,this.cancelled=!1,this.cancel_fn=null}return e.prototype.cancel=function(){return null!=this.cancel_fn&&this.cancel_fn(),this.cancelled=!0},e.prototype.poll=function(){var e,t=this;return(e=function(){var n;return t.cancelled?void 0:(n=at.clone(t.update_manager._handle_version_map),t.cancel_fn=t.update_manager.flob_client.await(n,t.update_manager._last_dslist_token,function(i,a){var r,s,o,l,c,d,h,u,p,f;if(t.cancel_fn=null,i)return 0===i.status?(console.log("await deltas failed (offline):",i),setTimeout(e,1e4)):i.status&&500<=(u=i.status)&&599>=u?(console.log("server error:",i),setTimeout(e,2e3)):(console.error("Got error in longpoll:",i),setTimeout(e,1e4));if(null!=a.get_deltas){p=a.get_deltas.deltas;for(l in p)if(s=p[l],null!=s.notfound)t.update_manager._data_queue.push({handle:l,notfound:s.notfound}),delete t.update_manager._handle_version_map[l];else if(null!=s.deltas){for(f=s.deltas,d=0,h=f.length;h>d;d++)o=f[d],t.update_manager._data_queue.push({handle:l,delta:o});c=n[l]+s.deltas.length,r=t.update_manager._handle_version_map[l],null!=r&&(t.update_manager._handle_version_map[l]=Math.max(r,c))}}return null!=a.list_datastores&&(t.update_manager._last_dslist_token=a.list_datastores.token,t.update_manager._data_queue.push({dslist:a.list_datastores})),setTimeout(e,0)}))})()},e}(),x=function(){function e(e){this.flob_client=e,this._data_queue=null,this._handle_version_map={},this._last_dslist_token=".",this._pending_poll=null,this._running=!1}return e.prototype.run=function(e){return this._data_queue=new r(e),this._running=!0,this._do_longpoll()},e.prototype.stop=function(){return this._pending_poll?this._pending_poll.cancel():void 0},e.prototype.add_poll=function(e,t){var n,i;return it(this._running,"update manager is not running"),n=this._handle_version_map[e],i=t,null!=n&&(i=Math.max(t,n)),this._handle_version_map[e]=i,this._do_longpoll()},e.prototype.remove_poll=function(e){return it(this._running,"update manager is not running"),e in this._handle_version_map?(delete this._handle_version_map[e],this._do_longpoll()):void 0},e.prototype._do_longpoll=function(){return it(this._running,"update manager is not running"),this._pending_poll&&(this._pending_poll.cancel(),this._pending_poll=null),this._pending_poll=new W(this),this._pending_poll.poll()},e}(),z=function(){function e(e,t){this.update_manager=e,this.flob_client=t,this.update_manager.run(this._handle_server_update.bind(this)),this._cached_objects={},this._dslist_listener=null,this._handle_to_dsid_map={}}return e.prototype.destroy=function(){var e;for(e in this._cached_objects)this._cached_objects[e].close();return this.update_manager.stop()},e.prototype.set_dslist_listener=function(e){return this._dslist_listener=e},e.prototype._evict=function(e){var t;return t=this._handle_to_dsid_map[e],null!=t?(delete this._handle_to_dsid_map[e],t in this._cached_objects&&this._cached_objects[t].mark_deleted(),this.update_manager.remove_poll(e)):void 0},e.prototype.close=function(e){var t;if(e in this._cached_objects)return t=this._cached_objects[e].get_handle(),this._cached_objects[e].close();throw new Error("Attempt to close unknown datastore: "+e)},e.prototype._handle_server_update=function(e,t){var n,i,a;return e.dslist?(this._dslist_listener&&this._dslist_listener(e.dslist),t(null)):(a=e.handle,n=this._handle_to_dsid_map[a],null==n?(console.log("unknown handle "+a+" (maybe datastore was evicted)",e,this._handle_to_dsid_map,this._cached_objects),t(null)):(i=e.delta,null!=e.notfound?(this._evict(a),t(null)):this._retrieve(n,a,function(e,n){return e?t(e):(n.receive_server_delta(i),t(null))})))},e.prototype.open=function(e,t,n){return this._cached_objects[e]&&this._cached_objects[e].open(),this._retrieve(e,t,n)},e.prototype._retrieve=function(e,t,n){var i,a=this;return i=this._cached_objects[e],null!=i?n(null,i):(this._handle_to_dsid_map[t]=e,this.flob_client.get_snapshot(t,function(i,r){var s,o,l;return null!=i?n(i):null!=a._cached_objects[e]?n(null,a._cached_objects[e]):(s=c.from_get_snapshot_resp(r),l=new w,o=U.fresh_managed_datastore(e,t,s,r.rev,l,a.flob_client),a.update_manager.add_poll(t,o.sync_state.last_rev),a._cached_objects[e]=o,n(null,o))}))},e}(),at.FieldOpTransformer=I=function(){function e(e){var a,r,s,o,c,d,h,u,p,b,v,y=this;for(this.rule_name=null!=e?e:"default",this.precedence=i[this.rule_name],this._transforms={},s=0,d=n.length;d>s;s++)r=n[s],this._transforms[r]={};for(v=["P","D"],o=0,h=v.length;h>o;o++)for(r=v[o],c=0,u=t.length;u>c;c++)a=t[c],this._transforms[r][a]=f,this._transforms[a][r]=m;for(b=0,p=t.length;p>b;b++)a=t[b],"LC"===a?this._transforms.LC.LC=function(){return[null,null]}:(this._transforms.LC[a]=m,this._transforms[a].LC=f);this._transforms.P.P=function(e,t){var n;return n=y.precedence(e.value,t.value),"left"===n?[e,null]:[null,t]},this._transforms.P.D=function(e,t){var n;return n=y.precedence(e.value,null),"left"===n?[e,null]:[null,t]},this._transforms.D.P=function(e,t){var n;return n=y.precedence(null,t.value),"left"===n?[e,null]:[null,t]},this._transforms.D.D=function(e,t){var n;return n=y.precedence(null,null),"left"===n?[e,null]:[null,t]},this._transforms.LP.LP=function(e,t){var n;return e.at!==t.at?[e,t]:(n=y.precedence(e.value,t.value),"left"===n?[e,null]:[null,t])},this._transforms.LP.LI=function(e,t){var n;return n=l(e),n.at+=t.before<=e.at?1:0,[n,t]},this._transforms.LP.LD=function(e,t){var n;return e.at===t.at?[null,t]:(n=l(e),n.at-=t.at<e.at?1:0,[n,t])},this._transforms.LP.LM=function(e,t){var n;return n=l(e),e.at===t.from?n.at=t.to:(n.at-=t.from<n.at?1:0,n.at+=t.to<=n.at?1:0),[n,t]},this._transforms.LI.LP=g(this._transforms.LP.LI),this._transforms.LI.LI=function(e,t){var n,i,a;return a=[l(e),l(t)],n=a[0],i=a[1],e.before<t.before?i.before+=1:n.before+=1,[n,i]},this._transforms.LI.LD=function(e,t){var n,i,a;return a=[l(e),l(t)],n=a[0],i=a[1],n.before-=t.at<e.before?1:0,i.at+=e.before<=t.at?1:0,[n,i]},this._transforms.LI.LM=function(e,t){var n,i,a,r;return r=[l(e),l(t)],i=r[0],a=r[1],e.before===t.to+1&&t.from<=t.to?[e,t]:e.before===t.to&&t.from>t.to?(i.before++,a.from++,[i,a]):(n=t.from<e.before?e.before-1:e.before,a.from+=e.before<=t.from?1:0,i.before=t.to<n?n+1:n,a.to+=n<=t.to?1:0,[i,a])},this._transforms.LD.LP=g(this._transforms.LP.LD),this._transforms.LD.LI=g(this._transforms.LI.LD),this._transforms.LD.LD=function(e,t){var n,i,a;return e.at===t.at?[null,null]:(a=[l(e),l(t)],n=a[0],i=a[1],e.at<t.at?i.at-=1:n.at-=1,[n,i])},this._transforms.LD.LM=function(e,t){var n,i,a;return e.at===t.from?(n=l(e),n.at=t.to,[n,null]):(a=[l(e),l(t)],n=a[0],i=a[1],n.at-=t.from<n.at?1:0,n.at+=t.to<=n.at?1:0,i.to+=i.from<i.to?1:0,i.from-=e.at<i.from?1:0,i.to-=e.at<i.to?1:0,i.to-=i.from<i.to?1:0,[n,i])},this._transforms.LM.LP=g(this._transforms.LP.LM),this._transforms.LM.LI=function(e,t){var n,i,a,r;return r=[l(e),l(t)],i=r[0],a=r[1],t.before===e.to+1&&e.from<=e.to?[e,t]:t.before===e.to&&e.from>e.to?(i.from++,i.to++,[i,a]):(n=e.from<t.before?t.before-1:t.before,i.from+=t.before<=e.from?1:0,a.before=e.to<n?n+1:n,i.to+=n<=e.to?1:0,[i,a])},this._transforms.LM.LD=g(this._transforms.LD.LM),this._transforms.LM.LM=function(e,t){var n,i,a,r,s,o,c,d,h,u,p;return e.from===t.from?e.to===t.to?[null,null]:t.from===t.to?[e,t]:(r=l(t),r.from=e.to,[null,r]):e.to===e.from?(a=l(e),a.from+=(t.to<=e.from)-(t.from<e.from),e.from===t.to&&t.from<t.to&&a.from--,a.to=a.from,[a,t]):t.to===t.from?(r=l(t),r.from+=(e.to<=t.from)-(e.from<t.from),r.to=r.from,[e,r]):(c=[l(e),l(t)],a=c[0],r=c[1],e.to===t.to&&e.from>e.to&&t.from>t.to?(a.to++,t.from>e.from?a.from++:r.from++,[a,r]):e.from===t.to&&t.from===e.to&&e.from<e.to?(r.from--,a.from++,[a,r]):e.from>e.to&&t.from<t.to&&t.to+1===e.to?[e,t]:(d=[e.to,e.from],s=d[0],n=d[1],s+=e.from<s?1:0,s-=t.from<s?1:0,s+=t.to<s?1:0,n-=t.from<n?1:0,n+=t.to<=n?1:0,s-=s>n?1:0,h=[t.to,t.from],o=h[0],i=h[1],o+=t.from<o?1:0,o-=e.from<o?1:0,o+=e.to<=o?1:0,i-=e.from<i?1:0,i+=e.to<=i?1:0,o-=o>i?1:0,u=[s,n],a.to=u[0],a.from=u[1],p=[o,i],r.to=p[0],r.from=p[1],[a,r]))}}var t,n,i,a,r,s,o,l,c,d,h,u,p,f,m,g,b,v,y;for(g=function(e){return it(null!=e),function(t,n){var i,a,r;return r=e(n,t),i=r[0],a=r[1],[a,i]}},a=["null","bool","num","str","blob","ts","list"],r={},d=v=0,y=a.length;y>v;d=++v)b=a[d],r[b]=d;return c=function(e){if(null==e)return"null";if(et.is_bool(e))return"bool";if(null!=e.I||et.is_number(e))return"num";if(et.is_string(e))return"str";if(null!=e.B)return"blob";if(null!=e.T)return"ts";if(et.is_array(e))return"list";throw new Error("Unrecognized value "+e)},p=function(e){return et.is_number(e)||null!=e.I},s=function(e){return null!=e.I?parseInt(e.I):e},u=function(e,t){var n,i,a;for(n=i=0,a=e.length;a>=0?a>i:i>a;n=a>=0?++i:--i){if(n>=t.length)return!1;if(h(e[n],t[n]))return!0;if(h(t[n],e[n]))return!1}return t.length>e.length},e._is_less_than=h=function(e,t){var n,i;if(n=c(e),i=c(t),n!==i)return r[n]<r[i];if("null"===n)return!1;if("bool"===n)return t&&!e;if("num"===n)return null!=e.I&&null!=t.I?at.int64_string_less_than(e.I,t.I):s(e)<s(t);if("str"===n)return t>e;if("blob"===n)return e.B<t.B;if("ts"===n)return parseInt(e.T,10)<parseInt(t.T,10);if("list"===n)return u(e,t);throw new Error("unknown type "+n)},e._compute_sum=o=function(e,t,n){var i,a,r,s,o,l;return i=null!=e.I&&null!=t.I&&null!=n.I,null!=e.I&&(e=parseInt(e.I)),null!=t.I&&(t=parseInt(t.I)),null!=n.I&&(n=parseInt(n.I)),s=0x8000000000000000,o=0x10000000000000000,l=0xfffffffffffff800,a=t-e,r=n+a,i&&(r>=s&&(r-=l),-s>r&&(r+=l),r={I:""+r}),r},m=function(e,t){return[null,t]},f=function(e){return[e,null]},n=["P","D","LC","LP","LI","LD","LM"],t=["LC","LP","LI","LD","LM"],e.copy=l=function(e){return M.from_array(JSON.parse(JSON.stringify(e)))},i={"default":function(){return"right"},remote:function(){return"right"},local:function(){return"left"},min:function(e,t){return h(e,t)?"left":"right"},max:function(e,t){return h(e,t)?"right":"left"},sum:function(){return"right"}},e.prototype.transform=function(e,t,n){var i,a,r,s,l;return null==n&&(n=null),"sum"===this.rule_name&&"P"===e.tag()&&"P"===t.tag()&&(null==n&&(n={I:"0"}),p(n)&&p(e.value)&&p(t.value))?(r=o(n,e.value,t.value),i=a=M.from_array(["P",r]),[i,a,t.value]):(s=this._transforms[e.tag()][t.tag()](e,t),l=function(){switch(t.tag()){case"P":return t.value;case"D":return null;default:return{L:!0}}}(),s.push(l),s)},e}(),at.ChangeTransformer=a=function(){function e(){this._transform_rules={},this._default_transformer=new I}var t,n,a,r,s,o,l,c;for(t={},c=["default","local","remote","min","max","sum"],o=0,l=c.length;l>o;o++)a=c[o],t[a]=new I(a);return s=function(e){return it(null!=e),function(t,n){var i,a,r;return r=e(n,t),i=r[0],a=r[1],[a,i]}},n=function(e){return e instanceof Array?e.slice():e},r=function(e,t){return e.tid===t.tid&&e.rowid===t.rowid},e.is_no_op=function(e){var t,n,i;if("U"!==e.tag())return!1;i=e.updates;for(n in i)return t=i[n],!1;return!0},e.compact=function(e){var t,n,i,a;for(t=[],i=0,a=e.length;a>i;i++)n=e[i],this.is_no_op(n)||t.push(n);return t},e.prototype.set_field_transformer=function(e,n,i){var a;return null==(a=this._transform_rules)[e]&&(a[e]={}),this._transform_rules[e][n]=t[i]},e.prototype.get_field_transformer=function(e,n){var i;return e in this._transform_rules?null!=(i=this._transform_rules[e][n])?i:this._default_transformer:t["default"]},e.prototype.transform_ii=function(e,t){var a,s,o;return r(e,t)?(a=function(e){var t,a,r,s,o;r={},o=e.fields;for(a in o)s=o[a],r[a]=M.from_array(["P",n(s)]);return t=i.from_array(["U",e.tid,e.rowid,r]),t.undo_extra={},t},s=a(e),o=a(t),this.transform_uu(s,o)):[[e],[t]]},e.prototype.transform_iu=function(e,t){return r(e,t)?it(!1,"Couldn't have updated a row that hasn't been inserted yet!"):[[e],[t]]},e.prototype.transform_id=function(e,t){return r(e,t)?it(!1,"Couldn't have deleted a row that hasn't been inserted yet!"):[[e],[t]]},e.prototype.transform_ui=s(e.prototype.transform_iu),e.prototype.transform_uu=function(e,t){var n,a,s,o,l,c,d,h,u,p,f,m,g,b,v,y,_,E,k;if(!r(e,t))return[[e],[t]];b=[{},{}],u=b[0],p=b[1],h={},v=e.updates;for(s in v)n=v[s],s in t.updates?(a=t.updates[s],f=null!=(_=e.undo_extra[s])?_:null,m=this.get_field_transformer(e.tid,s),E=m.transform(n,a,f),o=E[0],l=E[1],g=E[2],null!=o&&(u[s]=o,h[s]=null!=g?g:null),null!=l&&(p[s]=l)):(u[s]=n,h[s]=null!=(y=e.undo_extra[s])?y:null);k=t.updates;for(s in k)a=k[s],s in e.updates||(p[s]=a);return c=i.from_array(["U",e.tid,e.rowid,u]),c.undo_extra=h,d=i.from_array(["U",t.tid,t.rowid,p]),[[c],[d]]},e.prototype.transform_ud=function(e,t){return r(e,t)?[[],[t]]:[[e],[t]]},e.prototype.transform_di=s(e.prototype.transform_id),e.prototype.transform_du=s(e.prototype.transform_ud),e.prototype.transform_dd=function(e,t){return r(e,t)?[[],[]]:[[e],[t]]},e}(),at.DefaultResolver=w=function(){function e(){this._change_transformer=new a}return e.prototype.add_resolution_rule=function(e,t,n){return this._change_transformer.set_field_transformer(e,t,n)},e.prototype._transform_one=function(e,t){var n,i,r,s,o;return n=function(e){switch(e.tag()){case"I":return"i";case"U":return"u";case"D":return"d";default:throw new Error("unrecognized op type "+e.tag())}},s="transform_"+n(e)+n(t),o=this._change_transformer[s](e,t),i=o[0],r=o[1],i=a.compact(i),r=a.compact(r),[i,r]},e.prototype._transform_list=function(e,t){var n,i,a,r,s,o,l,c,d,h,u,p,f,m;if(0===e.length)return[[],t];if(0===t.length)return[e,[]];for(n=e[0],i=t[0],p=this._transform_one(n,i),r=p[0],s=p[1],f=this._transform_list(e.slice(1),s),a=f[0],s=f[1],c=0,h=a.length;h>c;c++)o=a[c],r.push(o);for(m=this._transform_list(r,t.slice(1)),r=m[0],l=m[1],d=0,u=l.length;u>d;d++)o=l[d],s.push(o);return[r,s]},e.prototype._resolve=function(e,t){var n,i,a,r,s,o,l;for(r=t.slice(),i=[],s=0,o=e.length;o>s;s++)a=e[s],l=this._transform_list(a,r),n=l[0],r=l[1],i.push(n);return[i,r]},e.prototype.resolve=function(e,t){var n,a,r,s,o,l,c,d,h,u,p,f,m,g,b,v,y,_,E,k,w,D,T,A,N,x,M,I,C,S,P,B;for(p=[],v=0,k=e.length;k>v;v++){for(d=e[v],a=[],S=d.changes,u=y=0,w=S.length;w>y;u=++y)s=S[u],l=i.from_array(JSON.parse(JSON.stringify(s))),l.undo_extra=at.clone(d.undo_extras[u]),a.push(l);p.push(a)}for(g=[],_=0,D=t.length;D>_;_++)for(d=t[_],P=d.changes,E=0,T=P.length;T>E;E++)r=P[E],g.push(r);for(B=this._resolve(p,g),f=B[0],c=B[1],m=[],u=M=0,A=f.length;A>M;u=++M){for(o=f[u],b=null,h=e[u].finalized,I=0,N=o.length;N>I;I++)s=o[I],delete s.undo_extra;o.length>0&&m.push(new H(o,b,h))}for(n={},C=0,x=c.length;x>C;C++)r=c[C],r.tid in n||(n[r.tid]={}),n[r.tid][r.rowid]=!0;return{rebased_deltas:m,affected_records:n}},e}(),Q=function(){function e(){this._waiting=[],this._running=!1}return e.prototype._run_next=function(){var e;this._running||this._waiting.length>0&&(e=this._waiting[0],this._waiting.shift(),this._running=!0,e())},e.prototype.request=function(e){return this._waiting.push(e),this._run_next()},e.prototype.finish=function(){return this._running=!1,setTimeout(this._run_next.bind(this),0)},e}(),r=function(){function e(e){this.consumer=e,this.items=[],this.sync_queue=new Q}return e.prototype.consume=function(){var e=this;return this.sync_queue.request(function(){var t;return 0===e.items.length?e.sync_queue.finish():(t=e.items.shift(),e.consumer(t,function(t){if(t)throw t;return e.sync_queue.finish(),e.consume()}))})},e.prototype.push=function(e){return this.items.push(e),this.consume()},e.prototype.run=function(){return this.consume()},e}(),at.clone=function(e){var t,n,i,a,r,s,o;if(e instanceof Array){for(o=[],r=0,s=e.length;s>r;r++)t=e[r],o.push(at.clone(t));return o}if(null!=e&&"object"==typeof e){i={};for(n in e)a=e[n],i[n]=at.clone(a);return i}return e},at.WEB64_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",at.randomElement=function(e){return e[Math.floor(Math.random()*e.length)]},at.randomWeb64String=function(e){var t;return function(){var n,i;for(i=[],t=n=0;e>=0?e>n:n>e;t=e>=0?++n:--n)i.push(at.randomElement(at.WEB64_ALPHABET));return i}().join("")},at.uint8ArrayFromBase64String=function(e){var t,n,i,a,r;for(e=e.replace(/-/g,"+").replace(/_/g,"/"),t=A.Util.atob(e),i=t.length,a=new Uint8Array(i),n=r=0;i>=0?i>r:r>i;n=i>=0?++r:--r)a[n]=t.charCodeAt(n);return a},at.dbase64FromBase64=function(e){return e.replace(/[+]/g,"-").replace(/[/]/g,"_").replace(/[\=]+$/g,"")},at.base64StringFromUint8Array=function(e){var t,n,i,a,r;for(n="",a=0,r=e.length;r>a;a++)t=e[a],n+=String.fromCharCode(t);return i=A.Util.btoa(n),at.dbase64FromBase64(i)},at.INT64_TAG="dbxInt64",at.isInt64=function(e){var t;return e&&"object"==typeof e&&e.constructor===Number&&isFinite(e)?(t=e[at.INT64_TAG],!et.is_string(t)||"0"!==t&&!at.nonzero_int64_approximate_regex.test(t)?!1:!0):!1},at.validateInt64=function(e){var t,n;if(!e&&"object"==typeof e&&e.constructor===Number&&isFinite(e))throw new Error("Not a finite boxed number: "+e);if(n=e[at.INT64_TAG],!et.is_string(n)||"0"!==n&&!at.nonzero_int64_approximate_regex.test(n))throw new Error("Missing or invalid tag in int64: "+n);if(t=parseInt(n,10),t!==Number(e))throw new Error("Tag in int64 does not match value "+Number(e)+": "+n);return e},at.toDsValue=function(e,t){var n,i;if(null==t&&(t=!0),null===e||"undefined"==typeof e)throw new Error("Bad value: "+e);if(et.is_string(e))return e;if(et.is_bool(e))return e;if(et.is_number(e)){if(null!=e[at.INT64_TAG])return at.validateInt64(e),{I:e[at.INT64_TAG]};if(isFinite(e))return e;if(isNaN(e))return{N:"nan"};if(1/0===Number(e))return{N:"+inf"};if(Number(e)===-1/0)return{N:"-inf"};throw new Error("Unexpected number: "+e)}if(et.is_array(e)){if(t)return function(){var t,n,a;for(a=[],t=0,n=e.length;n>t;t++)i=e[t],a.push(at.toDsValue(i,!1));return a}();throw new Error("Nested array not allowed: "+JSON.stringify(e))}if(et.is_date(e))return n=Math.round(e.getTime()),{T:""+n};if(et.isUint8Array(e))return{B:at.base64StringFromUint8Array(e)};throw new Error("Unexpected object: "+JSON.stringify(e))},at.fromDsValue=function(e,t,n,i){if(et.is_string(i))return i;if(et.is_bool(i))return i;if(et.is_number(i))return i;if(et.is_array(i))return new A.Datastore.List(e,t,n);if("object"!=typeof i)throw new Error("Unexpected value: "+i);if(null!=i.I)return A.Datastore.int64(i.I);if(null==i.N){if(null!=i.B)return at.uint8ArrayFromBase64String(i.B);if(null!=i.T)return new Date(parseInt(i.T,10));throw new Error("Unexpected object: "+JSON.stringify(i))}switch(i.N){case"nan":return 0/0;case"+inf":return 1/0;case"-inf":return-1/0;default:throw new Error("Unexpected object: "+JSON.stringify(i))}},at.matchDsValues=function(e,t){var n,i,a,r,s;i=function(e,t){if(null==e)throw new Error("Unexpected object: "+e);return null==t?!1:n(e,t)},n=function(e,t){var n,a,r,s,o,l;if(at.toDsValue(e),et.is_string(e)&&et.is_string(t))return String(e)===String(t);if(et.is_bool(e)&&et.is_bool(t))return"object"==typeof e&&(e=e.valueOf()),"object"==typeof t&&(t=t.valueOf()),Boolean(e)===Boolean(t);if(et.is_number(e)&&(et.is_number(t)||null!=t.N||null!=t.I))return t=at.fromDsValue(void 0,void 0,void 0,t),e[at.INT64_TAG]&&t[at.INT64_TAG]?(s=[A.Datastore.int64(e),A.Datastore.int64(t)],e=s[0],t=s[1],String(e[at.INT64_TAG])===String(t[at.INT64_TAG])):isNaN(e)&&isNaN(t)?!0:Number(e)===Number(t);if(et.is_array(e)&&et.is_array(t)){if(e.length!==t.length)return!1;for(n=a=0,o=e.length-1;o>=0?o>=a:a>=o;n=o>=0?++a:--a)if(!i(e[n],t[n]))return!1;return!0}if(et.is_date(e)&&(et.is_date(t)||null!=t.T))return null!=t.T&&(t=at.fromDsValue(void 0,void 0,void 0,t)),e-0===t-0;if(et.isUint8Array(e)&&(et.isUint8Array(t)||null!=t.B)){if(null!=t.B&&(t=at.fromDsValue(void 0,void 0,void 0,t)),e.length!==t.length)return!1;for(n=r=0,l=e.length-1;l>=0?l>=r:r>=l;n=l>=0?++r:--r)if(e[n]!==t[n])return!1;return!0}return!1};for(a in e)if(s=e[a],r=i(s,t[a]),!r)return r;return!0},J=function(){function e(e){this._datastore=e,this._cache={}}return e.prototype.get=function(e,t){return null==this._cache[e]?null:this._cache[e][t]},e.prototype.getOrCreate=function(e,t){var n;return null==this._cache[e]&&(this._cache[e]={}),n=this._cache[e][t],null==n&&(n=this._cache[e][t]=new A.Datastore.Record(this._datastore,e,t)),n},e.prototype.remove=function(e,t){return delete this._cache[e][t],et.is_empty(this._cache[e])&&delete this._cache[e],void 0},e}(),N=function(){function e(){this._registered_handlers=[]}return e.prototype.register=function(e,t){return e.addListener(t),this._registered_handlers.push([e,t]),void 0},e.prototype.unregister_all=function(){var e,t,n,i,a,r;for(a=this._registered_handlers,n=0,i=a.length;i>n;n++)r=a[n],t=r[0],e=r[1],t.removeListener(e);return void 0},e}(),A.Datastore.DatastoreInfo=function(){function e(e,t,n){this._dsid=e,this._handle=t,this._info_record_data=n}return e.prototype.toString=function(){return"Datastore.DatastoreInfo("+this._dsid+")"},e.prototype.getId=function(){return this._dsid},e.prototype.getHandle=function(){return this._handle},e.prototype.getTitle=function(){var e;return null!=(e=this._info_record_data)?e.title:void 0},e.prototype.getModifiedTime=function(){var e;return null!=(e=this._info_record_data)?e.mtime:void 0},e}(),A.Datastore.DatastoreListChanged=function(){function e(e){this._dsinfos=e}return e.prototype.toString=function(){return"Datastore.DatastoreListChanged("+this._dsinfos.length+" datastores)"},e.prototype.getDatastoreInfos=function(){return this._dsinfos},e}(),A.Datastore.impl.EventSourceWithInitialData=function(e){function t(e){this.options=e,t.__super__.constructor.call(this,e),this._have_event=!1,this._last_event=null,this._listenersChanged=new A.Util.EventSource}return lt(t,e),t.prototype._clearLastEvent=function(){return this._have_event=!1,this._last_event=null},t.prototype.addListener=function(e){var n;return n=t.__super__.addListener.call(this,e),this._have_event&&e(event),this._listenersChanged.dispatch(this._listeners),n},t.prototype.removeListener=function(e){var n;return n=t.__super__.removeListener.call(this,e),this._listenersChanged.dispatch(this._listeners),n},t.prototype.dispatch=function(e){return this._last_event=e,this._have_event=!0,t.__super__.dispatch.call(this,e)},t}(A.Util.EventSource),o="default",A.Datastore.DatastoreManager=function(){function e(e){var t=this;if(!e.isAuthenticated())throw new Error("DatastoreManager requires an authenticated Dropbox.Client!");this._flob_client=new C(e),this._datasync=new d(this._flob_client),this._dslist_initialized=!1,this.datastoreListChanged=new A.Datastore.impl.EventSourceWithInitialData,this.datastoreListChanged._listenersChanged.addListener(function(e){return 0!==e.length?t._init_live_dslist():void 0})}return e.prototype.datastoreListChanged=null,e.prototype.close=function(){return this._datasync.close()},e.prototype.toString=function(){return"Datastore.DatastoreManager()"},e.prototype._datastoreInfoFromListDatastoresResponseItem=function(e){var t,n,i,a,r;if(null!=e.info){t={},r=e.info;for(n in r)a=r[n],t[n]=et.is_array(a)?function(){var e,t,n;for(n=[],e=0,t=a.length;t>e;e++)i=a[e],n.push(at.fromDsValue(null,null,null,i));return n}():at.fromDsValue(null,null,null,a)}else t=null;return new A.Datastore.DatastoreInfo(e.dsid,e.handle,t)},e.prototype._getDatastoreInfosFromListResponse=function(e){var t;return function(){var n,i,a,r;for(a=e.datastores,r=[],n=0,i=a.length;i>n;n++)t=a[n],r.push(this._datastoreInfoFromListDatastoresResponseItem(t));return r}.call(this)},e.prototype._init_live_dslist=function(){var e,t=this;return this._dslist_initialized?void 0:(this._dslist_initialized=!0,e=function(e){return t.datastoreListChanged.dispatch(new A.Datastore.DatastoreListChanged(t._getDatastoreInfosFromListResponse(e)))},this._datasync.obj_manager.set_dslist_listener(e),this._flob_client.list_dbs(function(t,n){return t?(console.warn("Failed to get datastore list"),void 0):e(n)}))},e.prototype._wrapDatastore=function(e,t){return t&&(e._update_mtime(),e.sync()),new A.Datastore(this,e)},e.prototype._getOrCreateDatastoreByDsid=function(e,t){var n=this;return this._datasync.get_or_create(e,function(e,i,a){return null!=e?t(e):t(null,n._wrapDatastore(i,a))}),void 0},e.prototype._createDatastore=function(e,t,n){var i=this;return this._datasync.create(e,t,function(e,t,a){return null!=e?n(e):n(null,i._wrapDatastore(t,a))}),void 0},e.prototype._getExistingDatastoreByDsid=function(e,t){var n=this;return this._datasync.get_by_dsid(e,function(e,i){return null!=e?t(e):t(null,new A.Datastore(n,i))}),void 0},e.prototype.openDefaultDatastore=function(e){return this._getOrCreateDatastoreByDsid(o,e)},e.prototype.openDatastore=function(e,t){return this._getExistingDatastoreByDsid(e,t),void 0},e.prototype.createDatastore=function(e){var t,n;return n=at.randomWeb64String(Math.ceil(256/6)),t="."+at.dbase64FromBase64(A.Util.sha256(n)),this._createDatastore(t,n,e),void 0},e.prototype.deleteDatastore=function(e,t){var n=this;return this._flob_client.get_db(e,function(e,i){return null!=e?t(e):n._flob_client.delete_db(i.handle,function(e){return e?t(e):t(null)})}),void 0},e.prototype.listDatastores=function(e){var t=this;return this.datastoreListChanged._have_event?e(null,this.datastoreListChanged._last_event.getDatastoreInfos()):(this._flob_client.list_dbs(function(n,i){return n?e(n):e(null,t._getDatastoreInfosFromListResponse(i))}),void 0)},e}(),A.Datastore.List=function(){function e(e,t,n){this._datastore=e,this._record=t,this._field=n}return e.prototype.toString=function(){return"Datastore.List(("+this._record._tid+", "+this._record._rid+", "+this._field+"): "+JSON.stringify(this._array)+")"},e.prototype._array=function(){return this._record._rawFieldValues()[this._field]},e.prototype._checkValid=function(){if(this._record._checkNotDeleted(),!et.is_array(this._array()))throw new Error("Attempt to operate on deleted list ("+this._record._tid+", "+this._record._rid+", "+this._field+")")
},e.prototype._storeUpdate=function(e){var t;return t={},t[this._field]=e,this._record._storeUpdate(t),void 0},e.prototype._fixInsertionIndex=function(e){var t,n;if(!et.is_json_number(e))throw new RangeError("Index not a number: "+e);if(t=this._array().length,n=e>=0?e:t+e,n>=0&&t>=n)return n;throw new RangeError("Bad index for list of length "+t+": "+e)},e.prototype._fixIndex=function(e){var t,n;if(n=this._fixInsertionIndex(e),t=this._array().length,t>n)return n;throw new RangeError("Bad index for list of length "+t+": "+e)},e.prototype.get=function(e){var t;return this._checkValid(),t=at.clone(this._array()[this._fixIndex(e)]),at.fromDsValue(void 0,void 0,void 0,t)},e.prototype.set=function(e,t){return this._checkValid(),e=this._fixIndex(e),this._storeUpdate(["LP",e,at.toDsValue(t,!1)]),void 0},e.prototype.length=function(){return this._checkValid(),this._array().length},e.prototype.pop=function(){if(this._checkValid(),0===this._array().length)throw new Error("List is empty");return this.remove(this._array.length-1)},e.prototype.push=function(e){return this._checkValid(),this.insert(this._array().length,e),void 0},e.prototype.shift=function(){if(this._checkValid(),0===this._array().length)throw new Error("List is empty");return this.remove(0)},e.prototype.unshift=function(e){return this.insert(0,e),void 0},e.prototype.splice=function(){var e,t,n,i,a,r,s,o,l;if(i=arguments[0],t=arguments[1],e=3<=arguments.length?ct.call(arguments,2):[],this._checkValid(),!et.is_json_number(t)||0>t)throw new RangeError("Bad second arg to splice: "+i+", "+t);for(i=this._fixInsertionIndex(i),a=this.slice(i,i+t),n=s=0;t>=0?t>s:s>t;n=t>=0?++s:--s)this.remove(i);for(o=0,l=e.length;l>o;o++)r=e[o],this.insert(i,r),i++;return a},e.prototype.move=function(e,t){return this._checkValid(),e=this._fixIndex(e),t=this._fixIndex(t),e===t?void 0:(this._storeUpdate(["LM",e,t]),void 0)},e.prototype.remove=function(e){var t;return this._checkValid(),e=this._fixIndex(e),t=this.get(e),this._storeUpdate(["LD",e]),t},e.prototype.insert=function(e,t){return this._checkValid(),e=this._fixInsertionIndex(e),this._storeUpdate(["LI",e,at.toDsValue(t,!1)]),void 0},e.prototype.slice=function(e,t){var n;return this._checkValid(),function(){var i,a,r,s;for(r=this._array().slice(e,t),s=[],i=0,a=r.length;a>i;i++)n=r[i],s.push(at.fromDsValue(void 0,void 0,void 0,n));return s}.call(this)},e.prototype.toArray=function(){var e;return this._checkValid(),function(){var t,n,i,a;for(i=this._array().slice(),a=[],t=0,n=i.length;n>t;t++)e=i[t],a.push(at.fromDsValue(void 0,void 0,void 0,e));return a}.call(this)},e}(),A.Datastore.Record=function(){function e(e,t,n){this._datastore=e,this._tid=t,this._rid=n,this._deleted=!1,this._record_cache=this._datastore._record_cache,this._managed_datastore=this._datastore._managed_datastore}return e.prototype.get=function(e){var t;return this._checkNotDeleted(),t=this._rawFieldValues(),e in t?at.fromDsValue(this._datastore,this,e,t[e]):null},e.prototype.set=function(e,t){var n;return n={},n[e]=t,this.update(n)},e.prototype.getOrCreateList=function(e){var t,n;if(this._checkNotDeleted(),n=this._rawFieldValues(),null==n[e])t={},t[e]=["LC"],this._storeUpdate(t),n=this._rawFieldValues();else if(!et.is_array(n[e]))throw new Error("Can't call getOrCreateList on field "+e+" for record ("+this.tid+", "+this.rid+"): existing value "+n[e]+" is not a list");return at.fromDsValue(this._datastore,this,e,n[e])},e.prototype.getFields=function(){var e,t,n,i;this._checkNotDeleted(),e={},i=this._rawFieldValues();for(t in i)n=i[t],e[t]=at.fromDsValue(this._datastore,this,t,n);return e},e.prototype.update=function(e){var t,n,i;this._checkNotDeleted(),t={};for(n in e)i=e[n],null!=i?t[n]=["P",at.toDsValue(i)]:null!=this.get(n)&&(t[n]=["D"]);return et.is_empty(t)||this._storeUpdate(t),this},e.prototype.deleteRecord=function(){var e;return this._checkNotDeleted(),this._deleted=!0,this._record_cache.remove(this._tid,this._rid),e=d.changeFromArray(["D",this._tid,this._rid]),this._managed_datastore.perform_local_change(e),this._datastore._recordsChangedLocally([this]),this},e.prototype.has=function(e){var t;return this._checkNotDeleted(),t=this._rawFieldValues(),e in t},e.prototype.getId=function(){return this._rid},e.prototype.getTable=function(){return this._datastore.getTable(this._tid)},e.prototype.isDeleted=function(){return this._deleted},e.prototype.toString=function(){var e;return e=this.isDeleted()?"deleted":JSON.stringify(this.getFields()),"Datastore.Record(("+this._tid+", "+this._rid+"): "+e+")"},e.prototype._rawFieldValues=function(){return this._managed_datastore.query(this._tid,this._rid)},e.prototype._storeUpdate=function(e){var t;t=d.changeFromArray(["U",this._tid,this._rid,e]),this._managed_datastore.perform_local_change(t),this._datastore._recordsChangedLocally([this])},e.isValidId=function(e){var t;return t=new RegExp(et.SS_ID_REGEX),et.is_string(e)&&t.test(e)},e.prototype._checkNotDeleted=function(){if(this._deleted)throw new Error("Attempt to operate on deleted record ("+this._tid+", "+this._rid+")")},e}(),A.Datastore.RecordsChanged=function(){function e(e,t){this._recordsByTable=e,this._local=t}return e.prototype.toString=function(){var e,t,n,i,a,r,s;a=0,n=0,s=this._recordsByTable;for(r in s)e=s[r],a+=1,n+=e.length;return i=""+a+" "+(1===a?"table":"tables"),t=""+n+" "+(1===n?"record":"records"),"Datastore.RecordsChanged("+t+" in "+i+" changed "+(this._local?"locally":"remotely")+")"},e._fromRecordList=function(t,n){var i,a,r,s,o;for(a={},s=0,o=t.length;o>s;s++)i=t[s],r=i._tid,null==a[r]&&(a[r]=[]),a[r].push(i);return new e(a,n)},e.prototype.affectedRecordsByTable=function(){return this._recordsByTable},e.prototype.affectedRecordsForTable=function(e){var t;return null!=(t=this._recordsByTable[e])?t:[]},e.prototype.isLocal=function(){return this._local},e}(),X=A.Datastore.RecordsChanged,A.Datastore.Table=function(){function e(e,t){this._datastore=e,this._tid=t,this._record_cache=this._datastore._record_cache,this._managed_datastore=this._datastore._managed_datastore}return e.prototype.getId=function(){return this._tid},e.prototype.get=function(e){var t,n;if(!A.Datastore.Record.isValidId(e))throw new Error("Invalid record ID: "+e);return n=this._record_cache.get(this._tid,e),null!=n?(it(!n._deleted),n):(t=this._managed_datastore.query(this._tid,e),null==t?null:this._record_cache.getOrCreate(this._tid,e))},e.prototype.getOrInsert=function(e,t){var n;return n=this.get(e),n?n:this._insertWithId(e,t)},e.prototype.insert=function(e){var t;return t=this._datastore._generateRid(),it(null==this.get(t)),this._insertWithId(t,e)},e.prototype.query=function(e){var t,n,i,a,r,s,o;for(r=this._managed_datastore.list_rows_for_table(this._tid),i=[],s=0,o=r.length;o>s;s++)a=r[s],t=this._managed_datastore.query(this._tid,a),(null==e||at.matchDsValues(e,t))&&(n=this.get(a),it(null!=n),i.push(n));return i},e.prototype.setResolutionRule=function(e,t){if("remote"!==t&&"local"!==t&&"min"!==t&&"max"!==t&&"sum"!==t)throw new Error(""+t+" is not a valid resolution rule. Valid rules are 'remote', 'local', 'min', 'max', and 'sum'.");return this._managed_datastore.resolver.add_resolution_rule(this._tid,e,t),this},e.isValidId=function(e){var t;return t=new RegExp(et.SS_ID_REGEX),et.is_string(e)&&t.test(e)},e.prototype.toString=function(){return"Datastore.Table("+this._tid+")"},e.prototype._insertWithId=function(e,t){var n,i,a,r,s;i={};for(a in t)s=t[a],i[a]=at.toDsValue(s);return n=d.changeFromArray(["I",this._tid,e,i]),this._managed_datastore.perform_local_change(n),r=this._record_cache.getOrCreate(this._tid,e),this._datastore._recordsChangedLocally([r]),r},e}(),A.File.ShareUrl=function(){function e(e,t){this.url=e.url,this.expiresAt=A.Util.parseDate(e.expires),this.isDirect=t===!0?!0:t===!1?!1:"direct"in e?e.direct:Date.now()-this.expiresAt<=864e5,this.isPreview=!this.isDirect,this._json=null}return e.parse=function(e,t){return e&&"object"==typeof e?new A.File.ShareUrl(e,t):e},e.prototype.url=null,e.prototype.expiresAt=null,e.prototype.isDirect=null,e.prototype.isPreview=null,e.prototype.json=function(){return this._json||(this._json={url:this.url,expires:this.expiresAt.toUTCString(),direct:this.isDirect})},e}(),A.File.CopyReference=function(){function e(e){"object"==typeof e?(this.tag=e.copy_ref,this.expiresAt=A.Util.parseDate(e.expires),this._json=e):(this.tag=e,this.expiresAt=new Date(1e3*Math.ceil(Date.now()/1e3)),this._json=null)}return e.parse=function(e){return!e||"object"!=typeof e&&"string"!=typeof e?e:new A.File.CopyReference(e)},e.prototype.tag=null,e.prototype.expiresAt=null,e.prototype.json=function(){return this._json||(this._json={copy_ref:this.tag,expires:this.expiresAt.toUTCString()})},e}(),A.File.Stat=function(){function e(e){var t,n,i,a;switch(this._json=e,this.path=e.path,"/"!==this.path.substring(0,1)&&(this.path="/"+this.path),t=this.path.length-1,t>=0&&"/"===this.path.substring(t)&&(this.path=this.path.substring(0,t)),n=this.path.lastIndexOf("/"),this.name=this.path.substring(n+1),this.isFolder=e.is_dir||!1,this.isFile=!this.isFolder,this.isRemoved=e.is_deleted||!1,this.typeIcon=e.icon,this.modifiedAt=(null!=(i=e.modified)?i.length:void 0)?A.Util.parseDate(e.modified):null,this.clientModifiedAt=(null!=(a=e.client_mtime)?a.length:void 0)?A.Util.parseDate(e.client_mtime):null,e.root){case"dropbox":this.inAppFolder=!1;break;case"app_folder":this.inAppFolder=!0;break;default:this.inAppFolder=null}this.size=e.bytes||0,this.humanSize=e.size||"",this.hasThumbnail=e.thumb_exists||!1,this.versionTag=e.rev,this.contentHash=e.hash||null,this.mimeType=this.isFolder?e.mime_type||"inode/directory":e.mime_type||"application/octet-stream"}return e.parse=function(e){return e&&"object"==typeof e?new A.File.Stat(e):e},e.prototype.path=null,e.prototype.name=null,e.prototype.inAppFolder=null,e.prototype.isFolder=null,e.prototype.isFile=null,e.prototype.isRemoved=null,e.prototype.typeIcon=null,e.prototype.versionTag=null,e.prototype.contentHash=null,e.prototype.mimeType=null,e.prototype.size=null,e.prototype.humanSize=null,e.prototype.hasThumbnail=null,e.prototype.modifiedAt=null,e.prototype.clientModifiedAt=null,e.prototype.json=function(){return this._json},e}(),A.Http.AppInfo=function(){function e(e,t){var n;this.name=e.name,this._icons=e.icons,n=e.permissions||{},this.canUseDatastores=!!n.datastores,this.canUseFiles=!!n.files,this.canUseFullDropbox="full_dropbox"===n.files,this.hasAppFolder="app_folder"===n.files,this.key=t?t:e.key||null}return e.parse=function(e,t){return e?new A.Http.AppInfo(e,t):e},e.prototype.name=void 0,e.prototype.key=void 0,e.prototype.canUseDatastores=void 0,e.prototype.canUseFiles=void 0,e.prototype.hasAppFolder=void 0,e.prototype.canUseFullDropbox=void 0,e.prototype.icon=function(e,t){return t||(t=e),this._icons[""+e+"x"+t]||null},e.ICON_SMALL=64,e.ICON_LARGE=256,e}(),A.Http.PulledChanges=function(){function e(e){var t;this.blankSlate=e.reset||!1,this.cursorTag=e.cursor,this.shouldPullAgain=e.has_more,this.shouldBackOff=!this.shouldPullAgain,this.changes=e.cursor&&e.cursor.length?function(){var n,i,a,r;for(a=e.entries,r=[],n=0,i=a.length;i>n;n++)t=a[n],r.push(A.Http.PulledChange.parse(t));return r}():[]}return e.parse=function(e){return e&&"object"==typeof e?new A.Http.PulledChanges(e):e},e.prototype.blankSlate=void 0,e.prototype.cursorTag=void 0,e.prototype.changes=void 0,e.prototype.shouldPullAgain=void 0,e.prototype.shouldBackOff=void 0,e.prototype.cursor=function(){return this.cursorTag},e}(),A.Http.PulledChange=function(){function e(e){this.path=e[0],this.stat=A.File.Stat.parse(e[1]),this.stat?this.wasRemoved=!1:(this.stat=null,this.wasRemoved=!0)}return e.parse=function(e){return e&&"object"==typeof e?new A.Http.PulledChange(e):e},e.prototype.path=void 0,e.prototype.wasRemoved=void 0,e.prototype.stat=void 0,e}(),A.Http.RangeInfo=function(){function e(e){var t;(t=/^bytes (\d*)-(\d*)\/(.*)$/.exec(e))?(this.start=parseInt(t[1]),this.end=parseInt(t[2]),this.size="*"===t[3]?null:parseInt(t[3])):(this.start=0,this.end=0,this.size=null)}return e.parse=function(e){return"string"==typeof e?new A.Http.RangeInfo(e):e},e.prototype.start=null,e.prototype.size=null,e.prototype.end=null,e}(),A.Http.UploadCursor=function(){function e(e){this.replace(e)}return e.parse=function(e){return!e||"object"!=typeof e&&"string"!=typeof e?e:new A.Http.UploadCursor(e)},e.prototype.tag=null,e.prototype.offset=null,e.prototype.expiresAt=null,e.prototype.json=function(){return this._json||(this._json={upload_id:this.tag,offset:this.offset,expires:this.expiresAt.toUTCString()})},e.prototype.replace=function(e){return"object"==typeof e?(this.tag=e.upload_id||null,this.offset=e.offset||0,this.expiresAt=A.Util.parseDate(e.expires)||Date.now(),this._json=e):(this.tag=e||null,this.offset=0,this.expiresAt=new Date(1e3*Math.floor(Date.now()/1e3)),this._json=null),this},e}(),"function"==typeof A.Env.global.atob&&"function"==typeof A.Env.global.btoa?(A.Util.atob=function(e){return A.Env.global.atob(e)},A.Util.btoa=function(e){return A.Env.global.btoa(e)}):A.Env.global.require&&A.Env.global.Buffer?(A.Util.atob=function(e){var t,n;return t=new Buffer(e,"base64"),function(){var e,i,a;for(a=[],n=e=0,i=t.length;i>=0?i>e:e>i;n=i>=0?++e:--e)a.push(String.fromCharCode(t[n]));return a}().join("")},A.Util.btoa=function(e){var t,n;return t=new Buffer(function(){var t,i,a;for(a=[],n=t=0,i=e.length;i>=0?i>t:t>i;n=i>=0?++t:--t)a.push(e.charCodeAt(n));return a}()),t.toString("base64")}):function(){var e,t,n;return t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=function(e,n,i){var a,r;for(r=3-n,e<<=8*r,a=3;a>=r;)i.push(t.charAt(63&e>>6*a)),a-=1;for(a=n;3>a;)i.push("="),a+=1;return null},e=function(e,t,n){var i,a;for(a=4-t,e<<=6*a,i=2;i>=a;)n.push(String.fromCharCode(255&e>>8*i)),i-=1;return null},A.Util.btoa=function(e){var t,i,a,r,s,o;for(r=[],t=0,i=0,a=s=0,o=e.length;o>=0?o>s:s>o;a=o>=0?++s:--s)t=t<<8|e.charCodeAt(a),i+=1,3===i&&(n(t,i,r),t=i=0);return i>0&&n(t,i,r),r.join("")},A.Util.atob=function(n){var i,a,r,s,o,l,c;for(o=[],i=0,r=0,s=l=0,c=n.length;(c>=0?c>l:l>c)&&(a=n.charAt(s),"="!==a);s=c>=0?++l:--l)i=i<<6|t.indexOf(a),r+=1,4===r&&(e(i,r,o),i=r=0);return r>0&&e(i,r,o),o.join("")}}(),function(){var e,t,n,i,a,r,s,o,l,c,d;if(A.Util.hmac=function(t,i){return e(n(l(t),l(i),t.length,i.length))},A.Util.sha1=function(t){return e(a(l(t),t.length))},A.Util.sha256=function(t){return e(r(l(t),t.length))},A.Env.require)try{t=A.Env.require("crypto"),t.createHmac&&t.createHash&&(A.Util.hmac=function(e,n){var i;return i=t.createHmac("sha1",n),i.update(e),i.digest("base64")},A.Util.sha1=function(e){var n;return n=t.createHash("sha1"),n.update(e),n.digest("base64")},A.Util.sha256=function(e){var n;return n=t.createHash("sha256"),n.update(e),n.digest("base64")})}catch(h){i=h}return n=function(e,t,n,i){var r,s,o,l;return t.length>16&&(t=a(t,i)),o=function(){var e,n;for(n=[],s=e=0;16>e;s=++e)n.push(909522486^t[s]);return n}(),l=function(){var e,n;for(n=[],s=e=0;16>e;s=++e)n.push(1549556828^t[s]);return n}(),r=a(o.concat(e),64+n),a(l.concat(r),84)},a=function(e,t){var n,i,a,r,s,o,l,c,d,h,u,p,f,m,g,b,v;for(e[t>>2]|=1<<31-((3&t)<<3),e[(t+8>>6<<4)+15]=t<<3,g=Array(80),n=1732584193,a=4023233417,s=2562383102,l=271733878,d=3285377520,u=0,f=e.length;f>u;){for(i=n,r=a,o=s,c=l,h=d,p=v=0;80>v;p=++v)16>p?g[p]=0|e[u+p<<2>>2]:(m=(0|g[p-3<<2>>2])^(0|g[p-8<<2>>2])^(0|g[p-14<<2>>2])^(0|g[p-16<<2>>2]),g[p]=m<<1|m>>>31),b=0|(0|(n<<5|n>>>27)+d)+g[p<<2>>2],b=20>p?0|b+(0|(a&s|~a&l)+1518500249):40>p?0|b+(0|(a^s^l)+1859775393):60>p?0|(0|b+((a&s|a&l|s&l)-1894007588)):0|b+(0|(a^s^l)-899497514),d=l,l=s,s=a<<30|a>>>2,a=n,n=b;n=0|i+n,a=0|r+a,s=0|o+s,l=0|c+l,d=0|h+d,u=0|u+16}return[n,a,s,l,d]},r=function(e,t){var n,i,a,r,l,c,d,h,u,p,f,m,g,b,v,y,_,E,k,w,D,T,A,N,x,M,I,C,S,P,B,R;for(e[t>>2]|=1<<31-((3&t)<<3),e[(t+8>>6<<4)+15]=t<<3,S=Array(80),n=s[0],a=s[1],l=s[2],h=s[3],p=s[4],m=s[5],b=s[6],w=s[7],T=0,N=e.length;N>T;){for(i=n,r=a,c=l,u=h,f=p,g=m,v=b,D=w,A=R=0;64>R;A=++R)16>A?C=S[A]=0|e[T+A<<2>>2]:(_=0|S[A-15<<2>>2],y=(_<<25|_>>>7)^(_<<14|_>>>18)^_>>>3,k=0|S[A-2<<2>>2],E=(k<<15|k>>>17)^(k<<13|k>>>19)^k>>>10,C=S[A]=0|(0|y+(0|S[A-7<<2>>2]))+(0|E+(0|S[A-16<<2>>2]))),d=p&m^~p&b,x=n&a^n&l^a&l,M=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),I=(p<<26|p>>>6)^(p<<21|p>>>11)^(p<<7|p>>>25),P=0|(0|(0|w+I)+(0|d+C))+(0|o[A<<2>>2]),B=0|M+x,w=b,b=m,m=p,p=0|h+P,h=l,l=a,a=n,n=0|P+B;n=0|i+n,a=0|r+a,l=0|c+l,h=0|u+h,p=0|f+p,m=0|g+m,b=0|v+b,w=0|D+w,T+=16}return[n,a,l,h,p,m,b,w]},c=function(e){return 0>e&&(e=4*(1<<30)+e),e.toString(16)},s=[],o=[],function(){var e,t,n,i,a,r,l;for(t=function(e){return 0|4294967296*(e-Math.floor(e))},a=2,l=[],n=r=0;64>r;n=++r){for(;;){for(i=!0,e=2;a>=e*e;){if(0===a%e){i=!1;break}e+=1}if(i)break;a+=1}8>n&&(s[n]=t(Math.pow(a,.5))),o[n]=t(Math.pow(a,1/3)),l.push(a+=1)}return l}(),e=function(e){var t,n,i,a,r;for(a="",t=0,i=4*e.length;i>t;)n=t,r=(255&e[n>>2]>>(3-(3&n)<<3))<<16,n+=1,r|=(255&e[n>>2]>>(3-(3&n)<<3))<<8,n+=1,r|=255&e[n>>2]>>(3-(3&n)<<3),a+=d[63&r>>18],a+=d[63&r>>12],t+=1,a+=t>=i?"=":d[63&r>>6],t+=1,a+=t>=i?"=":d[63&r],t+=1;return a},d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=function(e){var t,n,i,a,r;for(t=[],i=255,n=a=0,r=e.length;r>=0?r>a:a>r;n=r>=0?++a:--a)t[n>>2]|=(e.charCodeAt(n)&i)<<(3-(3&n)<<3);return t}}(),A.Util.Oauth=function(){function e(e){this._id=null,this._secret=null,this._stateParam=null,this._authCode=null,this._token=null,this._tokenKey=null,this._tokenKid=null,this._error=null,this._appHash=null,this._loaded=null,this.setCredentials(e)}return e.prototype.setCredentials=function(e){if(e.key)this._id=e.key;else{if(!e.token)throw new Error("No API key supplied");this._id=null}return this._secret=e.secret||null,this._appHash=null,this._error=null,this._loaded=!0,this.reset(),e.token?(this._token=e.token,e.tokenKey&&(this._tokenKey=e.tokenKey,this._tokenKid=e.tokenKid)):e.oauthCode?this._authCode=e.oauthCode:e.oauthStateParam&&(this._stateParam=e.oauthStateParam),this},e.prototype.credentials=function(){var e;return e={},this._id&&(e.key=this._id),this._secret&&(e.secret=this._secret),null!==this._token?(e.token=this._token,this._tokenKey&&(e.tokenKey=this._tokenKey,e.tokenKid=this._tokenKid)):null!==this._authCode?e.oauthCode=this._authCode:null!==this._stateParam&&(e.oauthStateParam=this._stateParam),e},e.prototype.step=function(){return null!==this._token?A.Client.DONE:null!==this._authCode?A.Client.AUTHORIZED:null!==this._stateParam?this._loaded?A.Client.PARAM_LOADED:A.Client.PARAM_SET:null!==this._error?A.Client.ERROR:A.Client.RESET},e.prototype.setAuthStateParam=function(e){if(null===this._id)throw new Error("No API key supplied, cannot do authorization");return this.reset(),this._loaded=!1,this._stateParam=e,this},e.prototype.checkAuthStateParam=function(e){return this._stateParam===e&&null!==this._stateParam},e.prototype.authStateParam=function(){return this._stateParam},e.prototype.error=function(){return this._error},e.prototype.processRedirectParams=function(e){var t;if(e.error){if(null===this._id)throw new Error("No API key supplied, cannot process errors");return this.reset(),this._error=new A.AuthError(e),!0}if(e.code){if(null===this._id)throw new Error("No API key supplied, cannot do Authorization Codes");return this.reset(),this._loaded=!1,this._authCode=e.code,!0}if(t=e.token_type){if(t=t.toLowerCase(),"bearer"!==t&&"mac"!==t)throw new Error("Unimplemented token type "+t);if(this.reset(),this._loaded=!1,"mac"===t){if("hmac-sha-1"!==e.mac_algorithm)throw new Error("Unimplemented MAC algorithms "+e.mac_algorithm);this._tokenKey=e.mac_key,this._tokenKid=e.kid}return this._token=e.access_token,!0}return!1},e.prototype.authHeader=function(e,t,n){var i,a;return null===this._token?(a=null===this._secret?A.Util.btoa(""+this._id+":"):A.Util.btoa(""+this._id+":"+this._secret),"Basic "+a):null===this._tokenKey?"Bearer "+this._token:(i=this.macParams(e,t,n),"MAC kid="+i.kid+" ts="+i.ts+" "+("access_token="+this._token+" mac="+i.mac))},e.prototype.addAuthParams=function(e,t,n){var i;return null===this._token?(n.client_id=this._id,null!==this._secret&&(n.client_secret=this._secret)):(null!==this._tokenKey&&(i=this.macParams(e,t,n),n.kid=i.kid,n.ts=i.ts,n.mac=i.mac),n.access_token=this._token),n},e.prototype.authorizeUrlParams=function(e,t){var n;if("token"!==e&&"code"!==e)throw new Error("Unimplemented /authorize response type "+e);return n={client_id:this._id,state:this._stateParam,response_type:e},t&&(n.redirect_uri=t),n},e.prototype.accessTokenParams=function(e){var t;return t={grant_type:"authorization_code",code:this._authCode},e&&(t.redirect_uri=e),t},e.queryParamsFromUrl=function(e){var t,n,i,a,r,s,o,l,c,d;if(a=/^[^?#]+(\?([^\#]*))?(\#(.*))?$/.exec(e),!a)return{};for(o=a[2]||"","/"===o.substring(0,1)&&(o=o.substring(1)),t=a[4]||"",n=t.indexOf("?"),-1!==n&&(t=t.substring(n+1)),"/"===t.substring(0,1)&&(t=t.substring(1)),s={},d=o.split("&").concat(t.split("&")),l=0,c=d.length;c>l;l++)i=d[l],r=i.indexOf("="),-1!==r&&(s[decodeURIComponent(i.substring(0,r))]=decodeURIComponent(i.substring(r+1)));return s},e.prototype.macParams=function(e,t,n){var i,a;return i={kid:this._tokenKid,ts:A.Util.Oauth.timestamp()},a=e.toUpperCase()+"&"+A.Util.Xhr.urlEncodeValue(t)+"&"+A.Util.Xhr.urlEncodeValue(A.Util.Xhr.urlEncode(n)),i.mac=A.Util.hmac(a,this._tokenKey),i},e.prototype.appHash=function(){return this._appHash?this._appHash:this._appHash=A.Util.sha1("oauth2-"+this._id).replace(/[\/+=]/g,"")},e.prototype.reset=function(){return this._stateParam=null,this._authCode=null,this._token=null,this._tokenKey=null,this._tokenKid=null,this._error=null,this},e.timestamp=function(){return Math.floor(Date.now()/1e3)},e.randomAuthStateParam=function(){return["oas",Date.now().toString(36),Math.random().toString(36)].join("_")},e}(),null==Date.now&&(A.Util.Oauth.timestamp=function(){return Math.floor((new Date).getTime()/1e3)}),2274814865e3===new Date("Fri, 31 Jan 2042 21:01:05 +0000").valueOf()?A.Util.parseDate=function(e){return new Date(e)}:2274814865e3===Date.parse("Fri, 31 Jan 2042 21:01:05 +0000")?A.Util.parseDate=function(e){return new Date(Date.parse(e))}:function(){var e,t;return t=/^\w+\, (\d+) (\w+) (\d+) (\d+)\:(\d+)\:(\d+) (\+\d+|UTC|GMT)$/,e={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11},A.Util.parseDate=function(n){var i;return(i=t.exec(n))?new Date(Date.UTC(parseInt(i[3]),e[i[2]],parseInt(i[1]),parseInt(i[4]),parseInt(i[5]),parseInt(i[6]),0)):0/0}}(),A.Util.countUtf8Bytes=function(e){var t,n,i,a,r;for(t=0,i=a=0,r=e.length;r>=0?r>a:a>r;i=r>=0?++a:--a)n=e.charCodeAt(i),127>=n?t+=1:2047>=n?t+=2:n>=55296&&57343>=n?t+=2:65535>=n?t+=3:it(!1);return t},A.Env.global.XMLHttpRequest?(!A.Env.global.XDomainRequest||"withCredentials"in new XMLHttpRequest?(_=XMLHttpRequest,y=!1,b="undefined"!=typeof FormData&&-1===navigator.userAgent.indexOf("Firefox")):(_=XDomainRequest,y=!0,b=!1),v=!0):(_=A.Env.require("xhr2"),y=!1,b=!1,v=!1),A.Env.global.Uint8Array)if(Object.getPrototypeOf?g=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array(0))).constructor:Object.__proto__&&(g=new Uint8Array(0).__proto__.__proto__.constructor),A.Env.global.Blob){try{!function(){return 2===new Blob([new Uint8Array(2)]).size?(k=!0,E=!0):(E=!1,k=2===new Blob([new ArrayBuffer(2)]).size)}()}catch(dt){E=!1,k=!1,A.Env.global.WebKitBlobBuilder&&-1!==navigator.userAgent.indexOf("Android")&&(b=!1)}g===Object&&(E=!1)}else k=!1,E=!0;else g=null,k=!1,E=!1;A.Util.Xhr=function(){function e(e,t){this.method=e,this.isGet="GET"===this.method,this.url=t,this.wantHeaders=!1,this.headers={},this.params=null,this.body=null,this.preflight=!(this.isGet||"POST"===this.method),this.signed=!1,this.completed=!1,this.responseType=null,this.callback=null,this.xhr=null,this.onError=null}return e.Request=_,e.ieXdr=y,e.canSendForms=b,e.doesPreflight=v,e.ArrayBufferView=g,e.sendArrayBufferView=E,e.wrapBlob=k,e.prototype.xhr=null,e.prototype.onError=null,e.prototype.setParams=function(e){if(this.signed)throw new Error("setParams called after addOauthParams or addOauthHeader");if(this.params)throw new Error("setParams cannot be called twice");return this.params=e,this},e.prototype.setCallback=function(e){return this.callback=e,this},e.prototype.signWithOauth=function(e,t){return A.Util.Xhr.ieXdr?this.addOauthParams(e):this.preflight||!A.Util.Xhr.doesPreflight?this.addOauthHeader(e):this.isGet&&t?this.addOauthHeader(e):this.addOauthParams(e)},e.prototype.addOauthParams=function(e){if(this.signed)throw new Error("Request already has an OAuth signature");return this.params||(this.params={}),e.addAuthParams(this.method,this.url,this.params),this.signed=!0,this},e.prototype.addOauthHeader=function(e){if(this.signed)throw new Error("Request already has an OAuth signature");return this.params||(this.params={}),this.signed=!0,this.setHeader("Authorization",e.authHeader(this.method,this.url,this.params))},e.prototype.setBody=function(e){if(this.isGet)throw new Error("setBody cannot be called on GET requests");if(null!==this.body)throw new Error("Request already has a body");return"string"==typeof e||"undefined"!=typeof FormData&&e instanceof FormData||(this.headers["Content-Type"]="application/octet-stream",this.preflight=!0),this.body=e,this},e.prototype.setResponseType=function(e){return this.responseType=e,this},e.prototype.setHeader=function(e,t){var n;if(this.headers[e])throw n=this.headers[e],new Error("HTTP header "+e+" already set to "+n);if("Content-Type"===e)throw new Error("Content-Type is automatically computed based on setBody");return this.preflight=!0,this.headers[e]=t,this},e.prototype.reportResponseHeaders=function(){return this.wantHeaders=!0},e.prototype.setFileField=function(e,t,n,i){var a,r,s,o,l;if(null!==this.body)throw new Error("Request already has a body");if(this.isGet)throw new Error("setFileField cannot be called on GET requests");if("object"==typeof n){"undefined"!=typeof ArrayBuffer&&(n instanceof ArrayBuffer?A.Util.Xhr.sendArrayBufferView&&(n=new Uint8Array(n)):!A.Util.Xhr.sendArrayBufferView&&0===n.byteOffset&&n.buffer instanceof ArrayBuffer&&(n=n.buffer)),i||(i="application/octet-stream");try{n=new Blob([n],{type:i})}catch(c){r=c,window.WebKitBlobBuilder&&(o=new WebKitBlobBuilder,o.append(n),(a=o.getBlob(i))&&(n=a))}"undefined"!=typeof File&&n instanceof File&&(n=new Blob([n],{type:n.type})),l=n instanceof Blob}else l=!1;return l?(this.body=new FormData,this.body.append(e,n,t)):(i||(i="application/octet-stream"),s=this.multipartBoundary(),this.headers["Content-Type"]="multipart/form-data; boundary="+s,this.body=["--",s,"\r\n",'Content-Disposition: form-data; name="',e,'"; filename="',t,'"\r\n',"Content-Type: ",i,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",n,"\r\n","--",s,"--","\r\n"].join(""))},e.prototype.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")},e.prototype.paramsToUrl=function(){var e;return this.params&&(e=A.Util.Xhr.urlEncode(this.params),0!==e.length&&(this.url=[this.url,"?",e].join("")),this.params=null),this},e.prototype.paramsToBody=function(){if(this.params){if(null!==this.body)throw new Error("Request already has a body");if(this.isGet)throw new Error("paramsToBody cannot be called on GET requests");this.headers["Content-Type"]="application/x-www-form-urlencoded",this.body=A.Util.Xhr.urlEncode(this.params),this.params=null}return this},e.prototype.prepare=function(){var e,t,n,i,a=this;if(t=A.Util.Xhr.ieXdr,this.isGet||null!==this.body||t?(this.paramsToUrl(),null!==this.body&&"string"==typeof this.body&&(this.headers["Content-Type"]="text/plain; charset=utf8")):this.paramsToBody(),this.xhr=new A.Util.Xhr.Request,t?(this.xhr.onload=function(){return a.onXdrLoad()},this.xhr.onerror=function(){return a.onXdrError()},this.xhr.ontimeout=function(){return a.onXdrError()},this.xhr.onprogress=function(){}):this.xhr.onreadystatechange=function(){return a.onReadyStateChange()},this.xhr.open(this.method,this.url,!0),!t){i=this.headers;for(e in i)st.call(i,e)&&(n=i[e],this.xhr.setRequestHeader(e,n))}return this.responseType&&("b"===this.responseType?this.xhr.overrideMimeType&&this.xhr.overrideMimeType("text/plain; charset=x-user-defined"):this.xhr.responseType=this.responseType),this},e.prototype.send=function(e){var t,n;if(this.callback=e||this.callback,null!==this.body){t=this.body,A.Util.Xhr.sendArrayBufferView?t instanceof ArrayBuffer&&(t=new Uint8Array(t)):0===t.byteOffset&&t.buffer instanceof ArrayBuffer&&(t=t.buffer);try{this.xhr.send(t)}catch(i){if(n=i,A.Util.Xhr.sendArrayBufferView||!A.Util.Xhr.wrapBlob)throw n;t=new Blob([t],{type:"application/octet-stream"}),this.xhr.send(t)}}else this.xhr.send();return this},e.urlEncode=function(e){var t,n,i;t=[];for(n in e)i=e[n],t.push(this.urlEncodeValue(n)+"="+this.urlEncodeValue(i));return t.sort().join("&")},e.urlEncodeValue=function(e){return encodeURIComponent(e.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},e.urlDecode=function(e){var t,n,i,a,r,s;for(n={},s=e.split("&"),a=0,r=s.length;r>a;a++)i=s[a],t=i.split("="),n[decodeURIComponent(t[0])]=decodeURIComponent(t[1]);return n},e.prototype.onReadyStateChange=function(){var e,t,n,i,a,r,s,o,l,c,d,h,u,p,f;if(4!==this.xhr.readyState)return!0;if(this.completed)return!0;if(this.completed=!0,this.xhr.status<200||this.xhr.status>=300)return t=new A.ApiError(this.xhr,this.method,this.url),this.onError?this.onError(t,this.callback):this.callback(t),!0;if(this.wantHeaders?(e=this.xhr.getAllResponseHeaders(),s=e?A.Util.Xhr.parseResponseHeaders(e):this.guessResponseHeaders(),d=s["x-dropbox-metadata"]):(s=void 0,d=this.xhr.getResponseHeader("x-dropbox-metadata")),null!=d?d.length:void 0)try{c=JSON.parse(d)}catch(m){if(l=m,r=d.search(/\}\,\s*\{/),-1!==r)try{d=d.substring(0,r+1),c=JSON.parse(d)}catch(m){l=m,c=void 0}else c=void 0}else c=void 0;if(this.responseType){if("b"===this.responseType){for(a=null!=this.xhr.responseText?this.xhr.responseText:this.xhr.response,n=[],o=p=0,f=a.length;f>=0?f>p:p>f;o=f>=0?++p:--p)n.push(String.fromCharCode(255&a.charCodeAt(o)));u=n.join(""),this.callback(null,u,c,s)}else this.callback(null,this.xhr.response,c,s);return!0}switch(u=null!=this.xhr.responseText?this.xhr.responseText:this.xhr.response,i=this.xhr.getResponseHeader("Content-Type"),i&&(h=i.indexOf(";"),-1!==h&&(i=i.substring(0,h))),i){case"application/x-www-form-urlencoded":this.callback(null,A.Util.Xhr.urlDecode(u),c,s);break;case"application/json":case"text/javascript":this.callback(null,JSON.parse(u),c,s);break;default:this.callback(null,u,c,s)}return!0},e.parseResponseHeaders=function(e){var t,n,i,a,r,s,o,l;for(i={},n=e.split("\n"),o=0,l=n.length;l>o;o++)a=n[o],t=a.indexOf(":"),r=a.substring(0,t).trim().toLowerCase(),s=a.substring(t+1).trim(),i[r]=s;return i},e.prototype.guessResponseHeaders=function(){var e,t,n,i,a,r;for(e={},r=["cache-control","content-language","content-range","content-type","expires","last-modified","pragma","x-dropbox-metadata"],i=0,a=r.length;a>i;i++)t=r[i],n=this.xhr.getResponseHeader(t),n&&(e[t]=n);return e},e.prototype.onXdrLoad=function(){var e,t,n;if(this.completed)return!0;if(this.completed=!0,n=this.xhr.responseText,e=this.wantHeaders?{"content-type":this.xhr.contentType}:void 0,t=void 0,this.responseType)return this.callback(null,n,t,e),!0;switch(this.xhr.contentType){case"application/x-www-form-urlencoded":this.callback(null,A.Util.Xhr.urlDecode(n),t,e);break;case"application/json":case"text/javascript":this.callback(null,JSON.parse(n),t,e);break;default:this.callback(null,n,t,e)}return!0},e.prototype.onXdrError=function(){var e;return this.completed?!0:(this.completed=!0,e=new A.ApiError(this.xhr,this.method,this.url),this.onError?this.onError(e,this.callback):this.callback(e),!0)},e}(),nt="X-Dropbox-User-Agent",G="X-Dropbox-Request-Id",A.DatastoresClient={_dispatchDatastoreXhr:function(e,t,n,i,a,r){var s,o,c;return c=new A.Util.Xhr(e,t),a.setRequestId&&(o="xxxxxxxxxxxxxxxx".replace(/x/g,function(){return Math.floor(16*Math.random()).toString(16)}),c.setHeader(G,o)),it(null==n[nt]),n=at.clone(n),n[nt]="dropbox-js-datastore-sdk/"+l,c.setParams(n),c.signWithOauth(this.oauth,!1),s=function(e,t){var n;if(null!=e)return r(e);if(et.is_string(t)){console.log("Treating server response string as JSON:",t);try{t=JSON.parse(t)}catch(a){n=a,console.log("Error parsing response as JSON",n.stack)}}return r(null,i.fromJSON(t))},a.isLongPoll?this.dispatchLongPollXhr(c,s):this.dispatchXhr(c,s),c},_listDatastores:function(e){return this._dispatchDatastoreXhr("GET",this.urls.listDbs,{},O,{},e)},_getOrCreateDatastore:function(e,t){return this._dispatchDatastoreXhr("POST",this.urls.getOrCreateDb,{dsid:e},s,{},t)},_createDatastore:function(e,t,n){return this._dispatchDatastoreXhr("POST",this.urls.createDb,{dsid:e,key:t},s,{},n)
},_getDatastore:function(e,t){return this._dispatchDatastoreXhr("GET",this.urls.getDb,{dsid:e},S,{},t)},_deleteDatastore:function(e,t){return this._dispatchDatastoreXhr("POST",this.urls.deleteDb,{handle:e},D,{setRequestId:!0},t)},_putDelta:function(e,t,n){return this._dispatchDatastoreXhr("POST",this.urls.putDelta,{handle:e,rev:t.rev,nonce:t.nonce,changes:JSON.stringify(t.changes)},V,{setRequestId:!0},n)},_getSnapshot:function(e,t){return this._dispatchDatastoreXhr("GET",this.urls.getSnapshot,{handle:e},B,{},t)},_datastoreAwait:function(t,n,i){return this._dispatchDatastoreXhr("GET",this.urls.datastoreAwait,{get_deltas:JSON.stringify({cursors:t}),list_datastores:JSON.stringify({token:n})},e,{isLongPoll:!0},i)},getDatastoreManager:function(){var e,t=this;return null==this._datastoreManager&&(this._datastoreManager=new A.Datastore.DatastoreManager(this),e=function(){return t.authStep===A.Client.SIGNED_OUT?(t._datastoreManager.close(),t._datastoreManager=null,t.onAuthStepChange.removeListener(e)):void 0},this.onAuthStepChange.addListener(e)),this._datastoreManager}},function(){var e,t,n,i;n=A.DatastoresClient,i=[];for(t in n)e=n[t],i.push(A.Client.prototype[t]=e);return i}(),A.File.PublicUrl=A.File.ShareUrl,A.UserInfo=A.AccountInfo}.call(this),ABINE_DNTME.define("dropbox",function(){return ABINE_DNTME.Dropbox=Dropbox,Dropbox});